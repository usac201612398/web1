<!DOCTYPE html>
<html>
{% load static %}     
<head>
  <meta charset="UTF-8">
  <title>Entradas-Diarias-CFrio</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">   
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">

  <style>
    h1 {
        margin: 15px;
        font-family: Arial, sans-serif;
    }

    .half {
        display: flex;
        gap: 10px;
        text-align: center;
    }

    .box {
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        padding: 10px;
        flex: 1; 
    }

    td {
        padding: 0;
    }

    td input {
        width: 100%;
        border: none;
        background: transparent;
    }

    #consultar {
        margin: 10px 0;
    }

    .number-cell {
        text-align: right;
        padding-right: 8px;
    }
  </style>
</head>

<body>
  <h1 class="roboto">Panel</h1>

  <div class="container">
    <div class="half">
      <div class="box">
        <form>
          <label for="fecha">Fecha:</label>
          <input class="input" id="date" type="date" value="{{ fecha }}">
        </form>
      </div>
      <div class="box">
        <form>
          <label for="correo">Usuario:</label>
          <input class="input" id="correo" type="text" value="{{ usuario }}" readonly>
        </form>
      </div>
    </div>

    <button id="consultar" class="button is-success is-light"><i class="fas fa-search"></i> Consultar</button>

    <div class="table-container mt-3">
      <table class="table is-striped is-hoverable is-fullwidth" id="myTable">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Proveedor</th>
            <th>Cultivo</th>
            <th>ItemSAPCode</th>
            <th>ItemSAPName</th>
            <th>Categoria</th>
            <th>Tarimas</th>
            <th>Cajas</th>
            <th>Libras</th>
            <th>Merma</th>
            <th>%Merma</th>
            <th>pesoxcajaprom</th>
          </tr>
        </thead>
        <tbody>
          {% for registro in datos %} 
          <tr> 
            <td>{{ registro.fecha }}</td>
            <td>{{ registro.proveedor }}</td>
            <td>{{ registro.cultivo }}</td>
            <td>{{ registro.itemsapcode }}</td>
            <td>{{ registro.itemsapname }}</td>
            <td>{{ registro.categoria }}</td>
            <td class="number-cell" data-value="{{ registro.total_tarimas }}">{{ registro.total_tarimas }}</td>
            <td class="number-cell" data-value="{{ registro.total_cajas }}">{{ registro.total_cajas }}</td>
            <td class="number-cell" data-value="{{ registro.total_libras }}">{{ registro.total_libras }}</td>
            <td class="number-cell" data-value="{{ registro.total_merma }}">{{ registro.total_merma }}</td>
            <td class="number-cell" data-value="{{ registro.porcen_merma }}">{{ registro.porcen_merma }}</td>
            <td class="number-cell" data-value="{{ registro.pesoxcajaprom }}">{{ registro.pesoxcajaprom }}</td>
          </tr> 
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="{% static '/lib/cockies.js' %}"></script>

  <script>
    $(document).ready(function () {
      $('#myTable').DataTable();
    });

    // Formatear celdas numéricas a 2 decimales
    const formatCells = (tableId) => {
      const cells = document.querySelectorAll(`#${tableId} td.number-cell`);
      cells.forEach(cell => {
        const value = parseFloat(cell.getAttribute('data-value'));
        if (!isNaN(value)) {
          cell.textContent = value.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
      });
    };

    document.addEventListener('DOMContentLoaded', () => {
      formatCells('myTable');
    });

    document.getElementById('consultar').addEventListener('click', function () {
      const opcionSeleccionada2 = document.getElementById('date').value;
      const tbody = document.querySelector('#myTable tbody');
      tbody.innerHTML = '';

      fetch('{% url "reporte_inventario" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: new URLSearchParams({ 'opcion2': opcionSeleccionada2 })
      })
      .then(response => response.json())
      .then(data => {
        data.datos.forEach(item => {
          const fila = document.createElement('tr');
          fila.innerHTML = `
            <td>${item.fecha}</td>
            <td>${item.proveedor}</td>
            <td>${item.cultivo}</td>
            <td>${item.itemsapcode}</td>
            <td>${item.itemsapname}</td>
            <td>${item.categoria}</td>
            <td class="number-cell" data-value="${item.total_tarimas}"></td>
            <td class="number-cell" data-value="${item.total_cajas}"></td>
            <td class="number-cell" data-value="${item.total_libras}"></td>
            <td class="number-cell" data-value="${item.total_merma}"></td>
            <td class="number-cell" data-value="${item.porcen_merma}"></td>
            <td class="number-cell" data-value="${item.pesoxcajaprom}"></td>
          `;
          tbody.appendChild(fila);
        });

        formatCells('myTable');
      });
    });

    // Auto cargar fecha y usuario
    $(document).ready(function () {
      function authUsuario() {
        $.ajax({
          url: '{% url "obtener_nombre_usuario" %}',
          data: { 'category_id': "Consulta" },
          success: function (data) {
            $('#date').val(data.fecha);
            $('#correo').val(data.username);
          },
          error: function (xhr, status, error) {
            console.error('Error:', error);
          }
        });
      }

      authUsuario();
    });
  </script>
</body>
</html>
