<!DOCTYPE html>
<html lang="es">
{% load static %}
<head>
  <meta charset="UTF-8" />
  <title>Panel - Inventario Fruta</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">

  <style>
    body {
      background-color: #f9f9f9;
      font-family: 'Segoe UI', sans-serif;
    }

    .table-custom-header th {
      background: linear-gradient(to right, #6c757d, #495057);
      color: white;
      text-align: center;
    }

    .is-stretch {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .is-stretch > .field {
      flex: 1;
      min-width: 180px;
    }

    .content-controls {
      margin-top: 2rem;
    }

    .mb-1 {
      margin-bottom: 1rem;
    }

    #consultar {
      margin-bottom: 1rem;
    }
  </style>
</head>

<body>
<section class="section">
  <div class="container">

    <!-- CABECERA -->
    <section class="hero is-success is-small mb-5">
      <div class="hero-body">
        <div class="container has-text-centered">
          <h1 class="title is-3 has-text-white">Panel de Control</h1>
          <p class="subtitle is-6 has-text-white-ter">Gestión de ingreso de inventario de fruta</p>
        </div>
      </div>
    </section>

    <!-- FILTROS -->
    <form id="filtros">
      <div class="box" style="border: none;">
        <div class="is-stretch">
          <div class="field">
            <label class="label">Fecha</label>
            <input class="input" type="date" id="date" value="{{ fecha }}">
          </div>

          <div class="field">
            <label class="label">Proveedor</label>
            <div class="select is-fullwidth">
              <select id="Pro">
                <option value="">Seleccionar</option>
                <option value="SDC">SDC</option>
                <option value="INVERNADEROS TECNOLOGICOS S.A">INVERNADEROS TECNOLOGICOS S.A</option>
                <option value="PRODUCTOS DEL VALLE, S.A.">PRODUCTOS DEL VALLE, S.A.</option>
                <option value="HORTEX, S.A.">HORTEX, S.A.</option>
                <option value="DANIEL ESTUARDO GALICIA CARRERA">DANIEL ESTUARDO GALICIA CARRERA</option>
                <option value="INVERSIONES LA PASTORIA, S.A.">INVERSIONES LA PASTORIA, S.A.</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label class="label">Cultivo</label>
            <div class="select is-fullwidth">
              <select id="Cul">
                <option value="">Seleccionar</option>
                <option value="BLOCKY ORGANICO">BLOCKY ORGANICO</option>
                <option value="BLOCKY">BLOCKY</option>
                <option value="CHERRY">CHERRY</option>
                <option value="GRAPE">GRAPE</option>
                <option value="MEDLEY">MEDLEY</option>
                <option value="GRAPE ORGANICO">GRAPE ORGANICO</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label class="label">Categoría</label>
            <div class="select is-fullwidth">
              <select id="Cat">
                <option value="">Seleccionar</option>
                <option value="Exportación">Exportación</option>
                <option value="Carreta">Carreta</option>
                <option value="Cenma">Cenma</option>
                <option value="Devolución">Devolución</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label class="label">Usuario</label>
            <input class="input" type="text" id="correo" value="{{ usuario }}" readonly>
          </div>
        </div>
      </div>
    </form>

    <!-- BOTÓN CONSULTAR -->
    <button id="consultar" class="button is-success">
      <span class="icon"><i class="fas fa-search"></i></span>
      <span>Consultar</span>
    </button>

    <!-- TABLA -->
    <div class="box">
      <div class="table-container">
        <table class="table is-striped is-hoverable is-fullwidth" id="myTable">
          <thead class="table-custom-header">
            <tr>
              <th>Fecha</th>
              <th>Proveedor</th>
              <th>Cultivo</th>
              <th>ItemSAPCode</th>
              <th>ItemSAPName</th>
              <th>Categoría</th>
              <th>Tarimas</th>
              <th>Cajas</th>
              <th>Libras</th>
              <th>Merma</th>
              <th>% Merma</th>
              <th>Peso x Caja</th>
            </tr>
          </thead>
          <tbody>
            {% for registro in datos %}
            <tr>
              <td>{{ registro.fecha }}</td>
              <td>{{ registro.proveedor }}</td>
              <td>{{ registro.cultivo }}</td>
              <td>{{ registro.itemsapcode }}</td>
              <td>{{ registro.itemsapname }}</td>
              <td>{{ registro.categoria }}</td>
              <td class="number-cell" data-value="{{ registro.total_tarimas }}"></td>
              <td class="number-cell" data-value="{{ registro.total_cajas }}"></td>
              <td class="number-cell" data-value="{{ registro.total_libras }}"></td>
              <td class="number-cell" data-value="{{ registro.total_merma }}"></td>
              <td class="number-cell" data-value="{{ registro.porcen_merma }}"></td>
              <td class="number-cell" data-value="{{ registro.pesoxcajaprom }}"></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- BOTONES FINAL -->
    <div class="columns content-controls">
      <div class="column is-6">
        <a href="{% url 'salidasFruta_listValle' %}" class="button is-success is-medium is-fullwidth">
          <span class="icon"><i class="fas fa-home"></i></span>
          <span>Ir al Home</span>
        </a>
      </div>
      <div class="column is-6 has-text-right">
        <button type="button" class="button is-success is-medium is-fullwidth envio3">
          <span class="icon"><i class="fas fa-paper-plane"></i></span>
          <span>Enviar</span>
        </button>
      </div>
    </div>

  </div>
</section>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="{% static '/lib/cockies.js' %}"></script>

<script>
  $(document).ready(function () {
    $('#myTable').DataTable({
      pageLength: 20,
      lengthMenu: [5, 10, 20, 25, 50, 100],
      language: {
        lengthMenu: "Mostrar _MENU_ entradas",
        zeroRecords: "No se encontraron resultados",
        info: "Mostrando _START_ a _END_ de _TOTAL_ entradas",
        infoEmpty: "Mostrando 0 a 0 de 0 entradas",
        infoFiltered: "(filtrado de _MAX_ entradas totales)",
        search: "Buscar:",
        paginate: {
          first: "Primero",
          last: "Último",
          next: "Siguiente",
          previous: "Anterior"
        }
      }
    });

    // Formatear números a 2 decimales
    document.querySelectorAll('.number-cell').forEach(cell => {
      const value = parseFloat(cell.dataset.value);
      if (!isNaN(value)) {
        cell.textContent = value.toLocaleString('es-ES', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }
    });
  });

  // Consultar datos por AJAX
  document.getElementById('consultar').addEventListener('click', function () {
    const fecha = document.getElementById('date').value;
    const tbody = document.querySelector('#myTable tbody');
    tbody.innerHTML = '';

    fetch('{% url "reporte_inventario" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: new URLSearchParams({ 'opcion2': fecha })
    })
      .then(response => response.json())
      .then(data => {
        data.datos.forEach(item => {
          const fila = document.createElement('tr');
          fila.innerHTML = `
            <td>${item.fecha}</td>
            <td>${item.proveedor}</td>
            <td>${item.cultivo}</td>
            <td>${item.itemsapcode}</td>
            <td>${item.itemsapname}</td>
            <td>${item.categoria}</td>
            <td class="number-cell" data-value="${item.total_tarimas}"></td>
            <td class="number-cell" data-value="${item.total_cajas}"></td>
            <td class="number-cell" data-value="${item.total_libras}"></td>
            <td class="number-cell" data-value="${item.total_merma}"></td>
            <td class="number-cell" data-value="${item.porcen_merma}"></td>
            <td class="number-cell" data-value="${item.pesoxcajaprom}"></td>
          `;
          tbody.appendChild(fila);
        });

        // Formatear nuevamente
        document.querySelectorAll('.number-cell').forEach(cell => {
          const value = parseFloat(cell.dataset.value);
          if (!isNaN(value)) {
            cell.textContent = value.toLocaleString('es-ES', {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            });
          }
        });
      });
  });



$(document).ready(function() {
        // Función para cargar productos basados en la categoría seleccionada
    function authUsuario() {
        $.ajax({
            url: '{% url "obtener_nombre_usuario" %}',  // URL para la vista AJAX
            data: {
                'category_id': "Consulta"  // Envia el ID de la categoría como parámetro
            },
            success: function(data) {
                // Limpia las opciones actuales del campo 'name'
                var initialCategoryId =data.username;  // Obtiene el valor inicial del campo 'category'
                $('#date').val(data.fecha);
                $('#correo').val(data.username);
                if (initialCategoryId) {
                    console.log(initialCategoryId);
                }
            
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);  // Maneja errores de la solicitud
            }
        });
    }
    
    authUsuario();
    // Llama a la función de carga de productos al cargar la página
        
});

</script>
</body>
</html>