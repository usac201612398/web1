<!DOCTYPE html>
<html lang="es">
{% load static %}
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Registro Form</title>

    <!-- CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css" />

    <style>
        h1 {
            margin: 15px;
            font-family: Arial, sans-serif;
        }

        a {
            margin: 20px;
            font-family: Arial, sans-serif;
        }

        .half {
            display: flex;
            height: 100%;
            gap: 10px;
            text-align: center;
        }

        .box {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 15px;
            flex: 1;
            height: 100%;
        }

        td {
            padding: 0.3rem;
            vertical-align: middle;
        }

        td .editable-cell {
            width: 100%;
            min-height: 1.8rem;
            outline: none;
            padding: 0 5px;
            background: transparent;
            border-radius: 4px;
        }

        td .editable-cell:focus {
            background-color: #eef6ff;
            border: 1px solid #3490dc;
        }

        /* Resaltar inputs/celdas vacías */
        .border-danger {
            border: 2px solid #dc3545 !important;
            border-radius: 4px;
            background-color: #f8d7da !important;
        }

        button.eliminar {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
        }

        button.eliminar:hover {
            color: #a71d2a;
        }

        /* Responsive ajustes pequeños */
        @media (max-width: 768px) {
            .half {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <h1 class="roboto">Panel</h1>

    <div class="container mb-4">
        <div class="half">
            <div class="box">
                <label for="date" class="form-label">Fecha:</label>
                <input class="input" id="date" type="date" value="{{ fecha }}">
            </div>

            <div class="box">
                <label for="Lug" class="form-label">Región:</label>
                <div class="select w-100">
                    <select name="Lugar" id="Lug" class="w-100">
                        <option value="">-- Seleccione --</option>
                    </select>
                </div>
            </div>

            <div class="box">
                <label for="correo" class="form-label">Usuario:</label>
                <input class="input" id="correo" type="text" value="{{ usuario }}" readonly>
            </div>

            <div class="box">
                <label for="Via" class="form-label">Viaje:</label>
                <div class="select w-100">
                    <select name="viaje" id="Via" class="w-100">
                        <option value="">-</option>
                        <option value="Viaje 1">Viaje 1</option>
                        <option value="Viaje 2">Viaje 2</option>
                        <option value="Viaje 3">Viaje 3</option>
                        <option value="Viaje 4">Viaje 4</option>
                        <option value="Viaje 5">Viaje 5</option>
                        <option value="Viaje 6">Viaje 6</option>
                        <option value="Viaje 7">Viaje 7</option>
                        <option value="Viaje 8">Viaje 8</option>
                        <option value="Viaje 9">Viaje 9</option>
                        <option value="Viaje 10">Viaje 10</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="container mb-3">
        <div class="table-responsive">
            <table class="table is-striped is-hoverable is-fullwidth" id="myTable">
                <thead>
                    <tr>
                        <th>Encargado</th>
                        <th>Orden</th>
                        <th>Cultivo</th>
                        <th>Estructura</th>
                        <th>Variedad</th>
                        <th>Cajas</th>
                        <th>Eliminar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for registro in registros %}
                    <tr>
                        <td>{{ encargado }}</td>
                        <td>{{ registro.orden }}</td>
                        <td>{{ registro.cultivo }}</td>
                        <td>{{ registro.estructura }}</td>
                        <td>{{ registro.variedad }}</td>
                        <td><div contenteditable="true" class="editable-cell"></div></td>
                        <td><button class="eliminar" type="button" title="Eliminar fila"><i class="fas fa-trash-alt"></i></button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="container mb-5">
        <div class="half justify-content-start">
            <div class="box p-2">
                <button class="button is-primary envio3">Enviar</button>
            </div>
        </div>
    </div>

    <div class="container text-center mb-4">
        <a href="{% url 'salidasFruta_listValle' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Regresar a panel
        </a>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="{% static '/lib/cockies.js' %}"></script>

    <script>
        // Eliminar fila al hacer click en el icono de basura
        $(document).on('click', '.eliminar', function () {
            $(this).closest('tr').remove();
        });

        $('.envio3').on('click', function () {
            const fecha = $('#date').val().trim();
            const correo = $('#correo').val().trim();
            const origen = $('#Lug');
            const viaje = $('#Via');

            let errores = [];

            // Validar campos principales
            if (!fecha) errores.push("Fecha");
            if (!correo) errores.push("Usuario");
            if (!origen.val()) errores.push("Región");
            if (!viaje.val()) errores.push("Viaje");

            // Reseteamos estilos
            origen.removeClass('border-danger');
            viaje.removeClass('border-danger');
            $('#date').removeClass('border-danger');
            $('#correo').removeClass('border-danger');

            // Marcar selects/inputs vacíos
            if (!fecha) $('#date').addClass('border-danger');
            if (!correo) $('#correo').addClass('border-danger');
            if (!origen.val()) origen.addClass('border-danger');
            if (!viaje.val()) viaje.addClass('border-danger');

            if (errores.length > 0) {
                alert("Por favor completa los siguientes campos:\n" + errores.join(", "));
                return;
            }

            let camposVacios = false;
            let datos = [];

            $('#myTable tbody tr').each(function () {
                const $row = $(this);
                const filas = [];

                // Campos de texto (no editables)
                filas.push($row.find('td').eq(0).text().trim()); // encargado
                filas.push($row.find('td').eq(1).text().trim()); // orden
                filas.push($row.find('td').eq(2).text().trim()); // cultivo
                filas.push($row.find('td').eq(3).text().trim()); // estructura
                filas.push($row.find('td').eq(4).text().trim()); // variedad

                // Campo editable "Cajas"
                const $cajasDiv = $row.find('td').eq(5).find('.editable-cell');
                const cajasValor = $cajasDiv.text().trim();

                // Quitar borde antes de validar
                $cajasDiv.removeClass('border-danger');

                if (!cajasValor) {
                    $cajasDiv.addClass('border-danger');
                    camposVacios = true;
                }

                filas.push(cajasValor);

                // Agregar select y otros campos
                filas.push(origen.find('option:selected').text());
                filas.push(viaje.find('option:selected').text());
                filas.push(fecha);
                filas.push(correo);

                datos.push(filas);
            });

            if (camposVacios) {
                alert("Por favor completa todos los campos de Cajas.");
                return;
            }

            // Enviar AJAX
            $.ajax({
                url: '{% url "guardar_plantillaValle" %}',
                type: 'POST',
                dataType: "json",
                data: JSON.stringify({ array: datos }),
                contentType: 'application/json',
                headers: { 'X-CSRFToken': csrftoken },
                success: function (data) {
                    alert("Datos guardados correctamente.");
                    window.location.replace('{% url "salidasFruta_listValle" %}');
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    alert("Ocurrió un error al guardar los datos.");
                }
            });
        });

        // Carga dinámica del select "Región" y fecha/usuario (asumiendo que tienes estas funciones)
        $(document).ready(function () {
            function authUsuario() {
                $.ajax({
                    url: '{% url "obtener_nombre_usuario" %}',
                    data: { category_id: "Consulta" },
                    success: function (data) {
                        $('#date').val(data.fecha);
                        if (data.username) {
                            loadRegiones(data.username);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error:', error);
                    }
                });
            }

            function loadRegiones(username) {
                $.ajax({
                    url: '{% url "load_dataUsuario" %}',
                    data: { category_id: username },
                    success: function (data) {
                        $('#Lug').empty().append('<option value="">-- Seleccione --</option>');
                        $.each(data.datos, function (index, region) {
                            $('#Lug').append($('<option>').val(region.finca).text(region.finca));
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error('Error:', error);
                    }
                });
            }

            authUsuario();
        });
    </script>
</body>
</html>
