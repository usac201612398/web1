<!DOCTYPE html>
<html lang="es">
{% load static %}
<head>
  <meta charset="UTF-8" />
  <title>Panel - Supervision - Tomates</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      background-color: #f9f9f9;
    }
    .table-custom-header th {
      background: linear-gradient(to right, #6c757d, #495057);
      color: white !important;
      font-weight: bold;
      text-align: center;
    }
    .is-stretch {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .is-stretch > .field {
      flex: 1;
      min-width: 180px;
    }
    .content-controls {
      margin-top: 2rem;
    }
    .mb-1 {
      margin-bottom: 1rem;
    }
  </style>
</head>

<body>
  <section class="section">
    <div class="container">

      <!-- HEADER -->
      <section class="hero is-success is-small mb-5">
        <div class="hero-body">
          <div class="container has-text-centered">
            <h1 class="title is-3 has-text-white">Panel de Control</h1>
            <p class="subtitle is-6 has-text-white-ter">Evaluación de supervisión</p>
          </div>
        </div>
      </section>

      <!-- FILTROS -->
      <div class="filters">
        <form id="filtros">
          <div class="is-stretch">
            <div class="field">
              <label class="label" for="date">Fecha</label>
              <input class="input" type="date" id="date" >
            </div>

            <div class="field">
              <label class="label" for="finca">Area</label>
              <div class="select is-fullwidth">
                <select id="finca">
                  <option value="">Seleccionar</option>
                  <option value="RIO">RIO</option>
                  <option value="VALLE">VALLE</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label class="label" for="Cul">Cultivo</label>
              <div class="select is-fullwidth">
                <select id="Cul">
                  <option value="">Seleccionar</option>
                  <option value="BLOCKY ORGANICO">BLOCKY ORGANICO</option>
                  <option value="BLOCKY">BLOCKY</option>
                  <option value="CHERRY">CHERRY</option>
                  <option value="GRAPE">GRAPE</option>
                  <option value="MEDLEY">MEDLEY</option>
                  <option value="GRAPE ORGANICO">GRAPE ORGANICO</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label class="label" for="Estructura">Estructura</label>
              <div class="select is-fullwidth">
                <select id="Estructura">
                  <option value="">Seleccionar</option>
                  <option value="CM1">CM1</option>
                  <option value="CM2">CM2</option>
                  <option value="CM3">CM3</option>
                  <option value="CM4">CM4</option>
                  <option value="CM5">CM5</option>
                  <option value="CM6">CM6</option>
                  <option value="CM7">CM7</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label class="label" for="Sup">Supervisor</label>
              <div class="select is-fullwidth">
                <select id="Sup">
                  <option value="">Seleccionar</option>
                  <option value="Carlos Hernández">Carlos Hernández</option>
                  <option value="Rita Florián">Rita Florián</option>
                  <option value="Nolberto Morales">Nolberto Morales</option>
                </select>
              </div>
            </div>

          </div>
        </form>
      </div>

      <!-- TABLA -->
      <div class="box">
        <div class="table-container">
            <table class="table is-bordered is-fullwidth is-hoverable" id="myTable">
              <thead class="table-custom-header">
                <tr>
                  <th>Actividad</th>
                  <th>Parámetro</th>
                  <th>Excelente (4)</th>
                  <th>Bueno (3)</th>
                  <th>Regular (2)</th>
                  <th>Malo (1)</th>
                  <th>Observaciones</th>
                </tr>
              </thead>

              <tbody>

                <!-- DISTRIBUCIÓN DE EJES -->
                <tr>
                  <td>Distribución de ejes</td>
                  <td>Entre 20-21 plantas por gablete</td>
                  <td class="has-text-centered"><input type="radio" name="row1" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row1" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row1" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row1" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

                <tr>
                  <td>Distribución de ejes</td>
                  <td>Entre 17-19 plantas por gablete</td>
                  <td class="has-text-centered"><input type="radio" name="row2" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row2" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row2" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row2" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

                <tr>
                  <td>Distribución de ejes</td>
                  <td>Entre 14-16 plantas por gablete</td>
                  <td class="has-text-centered"><input type="radio" name="row3" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row3" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row3" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row3" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

                <tr>
                  <td>Distribución de ejes</td>
                  <td>Entre 10-13 plantas por gablete</td>
                  <td class="has-text-centered"><input type="radio" name="row4" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row4" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row4" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row4" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

                <!-- RALEO -->
                <tr>
                  <td>Raleo</td>
                  <td>Frutos bien formados y sin daño</td>
                  <td class="has-text-centered"><input type="radio" name="row5" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row5" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row5" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row5" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

                <tr>
                  <td>Raleo</td>
                  <td>Frutos en tallo</td>
                  <td class="has-text-centered"><input type="radio" name="row6" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row6" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row6" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row6" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

                <tr>
                  <td>Raleo</td>
                  <td>Frutos en hijos laterales</td>
                  <td class="has-text-centered"><input type="radio" name="row7" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row7" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row7" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row7" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

                <tr>
                  <td>Raleo</td>
                  <td>Frutas deformes o con problemas</td>
                  <td class="has-text-centered"><input type="radio" name="row8" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row8" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row8" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row8" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

                <!-- COSECHA -->
                <tr>
                  <td>Cosecha</td>
                  <td>Entre 85-95% de maduración</td>
                  <td class="has-text-centered"><input type="radio" name="row9" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row9" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row9" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row9" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

                <tr>
                  <td>Cosecha</td>
                  <td>Entre 75-85% de maduración</td>
                  <td class="has-text-centered"><input type="radio" name="row10" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row10" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row10" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row10" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

                <tr>
                  <td>Cosecha</td>
                  <td>Entre 70-75% de maduración</td>
                  <td class="has-text-centered"><input type="radio" name="row11" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row11" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row11" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row11" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

                <tr>
                  <td>Cosecha</td>
                  <td>Menos de 70% de maduración o con daños mecánicos</td>
                  <td class="has-text-centered"><input type="radio" name="row12" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row12" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row12" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row12" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

                <!-- IDENTIFICACIÓN DE PLAGAS Y ENFERMEDADES -->
                <tr>
                  <td>Identificación de plagas y enfermedades</td>
                  <td>Aviso temprano, la plaga no causó daño y se controló</td>
                  <td class="has-text-centered"><input type="radio" name="row13" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row13" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row13" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row13" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

                <tr>
                  <td>Identificación de plagas y enfermedades</td>
                  <td>Plantas con problema identificadas con su color respectivo</td>
                  <td class="has-text-centered"><input type="radio" name="row14" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row14" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row14" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row14" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

                <tr>
                  <td>Identificación de plagas y enfermedades</td>
                  <td>Aviso de plantas con problema pero no identificadas</td>
                  <td class="has-text-centered"><input type="radio" name="row15" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row15" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row15" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row15" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

                <tr>
                  <td>Identificación de plagas y enfermedades</td>
                  <td>Presencia de plagas sin identificación ni aviso</td>
                  <td class="has-text-centered"><input type="radio" name="row16" value="Excelente" data-puntaje="4"></td>
                  <td class="has-text-centered"><input type="radio" name="row16" value="Bueno" data-puntaje="3"></td>
                  <td class="has-text-centered"><input type="radio" name="row16" value="Regular" data-puntaje="2"></td>
                  <td class="has-text-centered"><input type="radio" name="row16" value="Malo" data-puntaje="1"></td>
                  <td><input class="input is-small" type="text"></td>
                </tr>

              </tbody>

            </table>

        </div>
        </div>


      <!-- BOTONES FINALES -->
    <div class="columns content-controls">
    <div class="column is-6">
        <a href="{% url 'supervisionproduccion_list' %}" class="button is-success is-medium is-fullwidth">
        <span class="icon"><i class="fas fa-home"></i></span>
        <span>Ir al Home</span>
        </a>
    </div>

    <div class="column is-6 has-text-right">
        <button type="button" class="button is-success is-medium is-fullwidth envio3">
        <span class="icon"><i class="fas fa-paper-plane"></i></span>
        <span>Enviar</span>
        </button>
    </div>
    </div>
  </section>

<script type="text/javascript" src="{% static '/lib/cockies.js' %}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  
$(document).ready(function () {

  // Fecha de hoy
  const hoy = new Date().toISOString().split('T')[0];
  $('#date').val(hoy);

  $('.envio3').on('click', function () {

    const boton = $(this);
    boton.prop('disabled', true);

    const fecha = $('#date').val();
    const area = $('#finca').val();
    const cultivo = $('#Cul').val();
    const estructura = $('#Estructura').val();
    const supervisor = $('#Sup').val();

    // Validación básica
    if (!fecha || !area || !cultivo || !estructura || !supervisor) {
      alert('Complete todos los filtros');
      boton.prop('disabled', false);
      return;
    }

    let datos = [];
    let incompletas = false;

    $('#myTable tbody tr').each(function () {

      const actividad = $(this).find('td').eq(0).text().trim();
      const parametro = $(this).find('td').eq(1).text().trim();

      const radio = $(this).find('input[type="radio"]:checked');

      if (radio.length === 0) {
        incompletas = true;
        return false; // corta el each
      }

      const clasificacion = radio.val();              // Excelente | Bueno | Regular | Malo
      const puntaje = radio.data('puntaje');           // 4 | 3 | 2 | 1
      const observaciones = $(this).find('input[type="text"]').val();

      datos.push({
        fecha: fecha,
        area: area,
        estructura: estructura,
        cultivo: cultivo,
        supervisor: supervisor,

        actividad: actividad,
        parametro: parametro,
        clasificacion: clasificacion,
        puntaje: puntaje,
        observaciones: observaciones,

        status: 'Abierta'
      });

    });

    if (incompletas) {
      alert('Debe evaluar todas las filas');
      boton.prop('disabled', false);
      return;
    }

    console.log(datos);

    $.ajax({
      url: "{% url 'supervision_grabar' %}",
      type: "POST",
      contentType: "application/json",
      headers: {
        "X-CSRFToken": getCookie('csrftoken')
      },
      data: JSON.stringify({ array: datos }),
      success: function (response) {
        alert(response.msm || 'Guardado correctamente');
        boton.prop('disabled', false);
      },
      error: function () {
        alert("Error al guardar");
        boton.prop('disabled', false);
      }
    });

  });

});
</script>

