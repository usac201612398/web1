<!DOCTYPE html>
<html lang="es">
{% load static %}
<head>
  <meta charset="UTF-8" />
  <title>Panel - Supervision - Tomates</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      background-color: #f9f9f9;
    }
    .table-custom-header th {
      background: linear-gradient(to right, #6c757d, #495057);
      color: white !important;
      font-weight: bold;
      text-align: center;
    }
    .is-stretch {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .is-stretch > .field {
      flex: 1;
      min-width: 180px;
    }
    .content-controls {
      margin-top: 2rem;
    }
    .mb-1 {
      margin-bottom: 1rem;
    }
  </style>
</head>

<body>
  <section class="section">
    <div class="container">

      <!-- HEADER -->
      <section class="hero is-success is-small mb-5">
        <div class="hero-body">
          <div class="container has-text-centered">
            <h1 class="title is-3 has-text-white">Panel de Control</h1>
            <p class="subtitle is-6 has-text-white-ter">Evaluación de supervisión</p>
          </div>
        </div>
      </section>

      <!-- FILTROS -->
      <div class="filters">
        <form id="filtros">
          <div class="is-stretch">

            <div class="field">
              <label class="label" for="date">Fecha</label>
              <input class="input" type="date" id="date" >
            </div>
            
            <div class="field">
              <label class="label" for="Sup">Supervisor</label>
                <input class="input" id="correo" type="text"  readonly>
            </div>

            <div class="field">
              <label class="label" for="finca">Area</label>
                <input class="input" id="finca" type="text"  readonly>
            </div>

            <div class="field">
              <label class="label" for="Cul">Cultivo</label>
              <div class="select is-fullwidth">
                <select id="Cul">
                  <option value="">Seleccionar</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label class="label" for="Estructura">Estructura</label>
              <div class="select is-fullwidth">
                <select id="Estructura">
                  <option value="">Seleccionar</option>
                  <option value="CM1">CM1</option>
                  <option value="CM2">CM2</option>
                  <option value="CM3">CM3</option>
                  <option value="CM4">CM4</option>
                  <option value="CM5">CM5</option>
                  <option value="CM6">CM6</option>
                  <option value="CM7">CM7</option>
                </select>
              </div>
            </div>
            <div class="field">
              <label class="label" for="Zona">Zona</label>
              <div class="select is-fullwidth">
                <select id="Zona">
                  <option value="">Seleccionar</option>
                  <option value="Z1">Z1</option>
                  <option value="Z2">Z2</option>
                </select>
              </div>
            </div>
            
            

          </div>
        </form>
      </div>

      <!-- TABLA -->
      <div class="box">
        <div class="table-container">
            <table class="table is-bordered is-fullwidth is-hoverable" id="myTable">
              <thead class="table-custom-header">
                <tr>
                  <th>Actividad</th>
                  <th>Ref</th>
                  <th colspan="5">Cantidad (5 muestras)</th>
                  <th>Observaciones</th>
                </tr>
              </thead>

              <tbody>
                <!-- DESHOJE -->
                <tr>
                  <td>Deshoje</td>
                  <td><input class="input ref" type="number"></td>

                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>

                  <td><input class="input obs" type="text"></td>
                </tr>

                <!-- GANCHOS -->
                <tr>
                  <td>Ganchos</td>
                  <td></td>
                  <td colspan="5"><input class="input cant-unica" type="number"></td>
                  <td><input class="input obs" type="text"></td>
                </tr>

                <!-- DESCORONE -->
                <tr>
                  <td>Descorone</td>
                  <td></td>

                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>

                  <td><input class="input obs" type="text"></td>
                </tr>
              </tbody>
            </table>
        </div>
        </div>


      <!-- BOTONES FINALES -->
    <div class="columns content-controls">
    <div class="column is-6">
        <a href="{% url 'supervisionproduccion_list' %}" class="button is-success is-medium is-fullwidth">
        <span class="icon"><i class="fas fa-home"></i></span>
        <span>Ir al Home</span>
        </a>
    </div>

    <div class="column is-6 has-text-right">
        <button type="button" class="button is-success is-medium is-fullwidth envio3">
        <span class="icon"><i class="fas fa-paper-plane"></i></span>
        <span>Enviar</span>
        </button>
    </div>
    </div>
  </section>

<script type="text/javascript" src="{% static '/lib/cockies.js' %}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  
$(document).ready(function () {

  // Fecha de hoy
  const hoy = new Date().toISOString().split('T')[0];
  $('#date').val(hoy);

function promedio(valores) {
  let suma = 0;
  let count = 0;

  valores.each(function () {
    const v = parseFloat($(this).val());
    if (!isNaN(v)) {
      suma += v;
      count++;
    }
  });

  return count > 0 ? (suma / count).toFixed(2) : null;
}

function authUsuario() {
  $.ajax({
    url: '{% url "obtener_nombre_usuario" %}',
    success: function (data) {

      // CORREO
      $('#correo').val(data.encargado);

      // FINCA (AREA)
      $('#finca').val(data.finca);

      // CULTIVO (limpiar y cargar)
      $('#Cul').empty();
      $('#Cul').append('<option value="">Seleccionar</option>');

      $.each(data.adicionales, function (index, item) {
        $('#Cul').append(
          $('<option>', {
            value: item.cultivo,
            text: item.cultivo
          })
        );
      });
    },
    error: function (xhr, status, error) {
      console.error('Error:', error);
    }
  });
}

authUsuario();

  $('.envio3').on('click', function () {

    const boton = $(this);
    boton.prop('disabled', true);

    const fecha = $('#date').val();
    const area = $('#finca').val();
    const cultivo = $('#Cul').val();
    const estructura = $('#Estructura').val();
    const zona = $('#Zona').val();
    const supervisor = $('#correo').val();

    // VALIDACIÓN DE FILTROS
if (!fecha) {
  alert('Debe seleccionar una fecha');
  boton.prop('disabled', false);
  return;
}

if (!supervisor) {
  alert('Supervisor no válido');
  boton.prop('disabled', false);
  return;
}

if (cultivo === "") {
  alert('Debe seleccionar un cultivo');
  $('#Cul').parent().addClass('is-danger');
  boton.prop('disabled', false);
  return;
}

if (estructura === "") {
  alert('Debe seleccionar una estructura');
  $('#Estructura').parent().addClass('is-danger');
  boton.prop('disabled', false);
  return;
}

if (zona === "") {
  alert('Debe seleccionar una zona');
  $('#Zona').parent().addClass('is-danger');
  boton.prop('disabled', false);
  return;
}


    let datos = [];
    let incompletas = false;

    
  $('#myTable tbody tr').each(function () {

    const actividad = $(this).find('td').eq(0).text().trim();
    let cantidad = null;
    let ref = null;

    if (actividad === 'Deshoje') {
      ref = $(this).find('.ref').val();
      cantidad = promedio($(this).find('.cant'));

      if (!ref || ref <= 0) {
        alert('Debe ingresar referencia válida en Deshoje');
        incompletas = true;
        return false;
      }
    }
    else if (actividad === 'Descorone') {
      cantidad = promedio($(this).find('.cant'));
    }
    else {
      cantidad = $(this).find('.cant-unica').val();
    }

    if (!cantidad || cantidad <= 0) {
      alert('Cantidad inválida en ' + actividad);
      incompletas = true;
      return false;
    }

    datos.push({
      fecha,
      zona,
      estructura,
      cultivo,
      supervisor,
      actividad,
      ref,
      cantidad,
      observaciones: $(this).find('.obs').val(),
      status: 'Abierta'
    });
  });

    console.log(datos);

    $.ajax({
      url: "{% url 'supervisionproduccion_grabar' %}",
      type: "POST",
      contentType: "application/json",
      headers: {
        "X-CSRFToken": getCookie('csrftoken')
      },
      data: JSON.stringify({ array: datos }),
      success: function (response) {
        alert(response.msm || 'Guardado correctamente');
        boton.prop('disabled', false);
        
        window.location.replace('https://sdc-iot.popoyan.com.gt/plantaE/supervisionproduccion');
      },
      error: function () {
        alert("Error al guardar");
        boton.prop('disabled', false);
      }
    });

  });

});
</script>