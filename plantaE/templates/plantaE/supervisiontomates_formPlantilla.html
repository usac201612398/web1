<!DOCTYPE html>
<html lang="es">
{% load static %}
<head>
  <meta charset="UTF-8" />
  <title>Panel - Supervision - Tomates</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      background-color: #f9f9f9;
    }
    .table-container table {
    border-radius: 8px;
    overflow: hidden;
}
    .table-custom-header th {
        background: linear-gradient(to right, #28a745, #218838);
        color: #fff;
        text-align: center;
    }
    .table tbody tr:nth-child(even) {
    background-color: #f3f7f3;
}
    .is-stretch {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .is-stretch > .field {
      flex: 1;
      min-width: 180px;
    }
    .content-controls {
      margin-top: 2rem;
    }
    .mb-1 {
      margin-bottom: 1rem;
    }
    .button.is-success {
    background: linear-gradient(90deg, #28a745, #218838);
    border: none;
    transition: transform 0.2s, box-shadow 0.2s;
}

.button.is-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
}
  </style>
</head>

<body>
  <section class="section">
    <div class="container">

      <!-- HEADER -->
      <section class="hero is-medium mb-5" style="background: linear-gradient(90deg, #28a745, #218838);">
        <div class="hero-body">
          <div class="container has-text-centered">
            <h1 class="title is-2 has-text-white"><i class="fas fa-seedling"></i> Panel de Supervisión</h1>
            <p class="subtitle is-5 has-text-white-ter">Evaluación de supervisión de cultivos</p>
          </div>
        </div>
      </section>
<div class="box">
  <h2 class="title is-5">Filtros</h2>
  <div class="columns is-multiline">
    <div class="column is-one-quarter">
      <div class="field">
        <label class="label">Fecha</label>
        <div class="control has-icons-left">
          <input class="input" type="date" id="date">
          <span class="icon is-small is-left">
            <i class="fas fa-calendar-alt"></i>
          </span>
        </div>
      </div>
    </div>
    <div class="column is-one-quarter">
      <div class="field">
        <label class="label">Supervisor</label>
        <input class="input" id="correo" type="text" readonly placeholder="Usuario asignado">
      </div>
    </div>
    <div class="column is-one-quarter">
      <div class="field">
        <label class="label">Área</label>
        <input class="input" id="finca" type="text" readonly placeholder="Área asignada">
      </div>
    </div>
    <div class="column is-one-quarter">
      <div class="field">
        <label class="label">Cultivo</label>
        <div class="control">
          <div class="select is-fullwidth">
            <select id="Cul">
              <option value="">Seleccionar</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

      <!-- TABLA -->
      <div class="box">
        <div class="table-container">
            <table class="table is-bordered is-fullwidth is-hoverable" id="myTable">
              <thead class="table-custom-header">
                <tr>
                  <th>Actividad</th>
                  <th>Ref</th>
                  <th colspan="5">Cantidad (5 muestras)</th>
                  <th>Observaciones</th>
                </tr>
              </thead>

              <tbody>
                <!-- DESHOJE -->
                <tr>
                  <td>Deshoje</td>
                  <td><input class="input ref" type="number"></td>

                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>

                  <td><input class="input obs" type="text"></td>
                </tr>

                <!-- GANCHOS -->
                <tr>
                  <td>Ganchos</td>
                  <td></td>
                  <td colspan="5"><input class="input cant-unica" type="number"></td>
                  <td><input class="input obs" type="text"></td>
                </tr>

                <!-- DESCORONE -->
                <tr>
                  <td>Descorone</td>
                  <td></td>

                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>
                  <td><input class="input cant" type="number"></td>

                  <td><input class="input obs" type="text"></td>
                </tr>
              </tbody>
            </table>
        </div>
        </div>


      <!-- BOTONES FINALES -->
    <div class="columns content-controls">
    <div class="column is-6">
        <a href="{% url 'supervisionproduccion_list' %}" class="button is-success is-medium is-fullwidth">
        <span class="icon"><i class="fas fa-home"></i></span>
        <span>Ir al Home</span>
        </a>
    </div>

    <div class="column is-6 has-text-right">
        <button type="button" class="button is-success is-medium is-fullwidth envio3">
        <span class="icon"><i class="fas fa-paper-plane"></i></span>
        <span>Enviar</span>
        </button>
    </div>
    </div>
  </section>

<script type="text/javascript" src="{% static '/lib/cockies.js' %}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  
$(document).ready(function () {

  // Fecha de hoy
  const hoy = new Date().toISOString().split('T')[0];
  $('#date').val(hoy);

function promedio(valores) {
  let suma = 0;
  let count = 0;

  valores.each(function () {
    const v = parseFloat($(this).val());
    if (!isNaN(v)) {
      suma += v;
      count++;
    }
  });

  return count > 0 ? (suma / count).toFixed(2) : null;
}

function authUsuario() {
  $.ajax({
    url: '{% url "obtener_nombre_usuario" %}',
    success: function (data) {

      // CORREO
      $('#correo').val(data.encargado);

      // FINCA (AREA)
      $('#finca').val(data.finca);

      // CULTIVO (limpiar y cargar)
      $('#Cul').empty();
      $('#Cul').append('<option value="">Seleccionar</option>');

      $.each(data.adicionales, function (index, item) {
        $('#Cul').append(
          $('<option>', {
            value: item.cultivo,
            text: item.cultivo
          })
        );
      });
    },
    error: function (xhr, status, error) {
      console.error('Error:', error);
    }
  });
}

authUsuario();

$('.envio3').on('click', function () {
    const boton = $(this);
    boton.prop('disabled', true);

    const fecha = $('#date').val();
    const area = $('#finca').val();
    const cultivo = $('#Cul').val();
    const estructura = $('#Estructura').val();
    const zona = $('#Zona').val();
    const supervisor = $('#correo').val();

    // ====== VALIDACIÓN DE FILTROS ======
    if (!fecha) { alert('Debe seleccionar una fecha'); boton.prop('disabled', false); return; }
    if (!supervisor) { alert('Supervisor no válido'); boton.prop('disabled', false); return; }
    if (cultivo === "") { alert('Debe seleccionar un cultivo'); $('#Cul').parent().addClass('is-danger'); boton.prop('disabled', false); return; }
    if (estructura === "") { alert('Debe seleccionar una estructura'); $('#Estructura').parent().addClass('is-danger'); boton.prop('disabled', false); return; }
    if (zona === "") { alert('Debe seleccionar una zona'); $('#Zona').parent().addClass('is-danger'); boton.prop('disabled', false); return; }

    // ====== VALIDACIÓN DE TABLA ======
    let datos = [];
    let incompletas = false;

    $('#myTable tbody tr').each(function () {
        const actividad = $(this).find('td').eq(0).text().trim();
        let cantidad = null;
        let ref = null;

        if (actividad === 'Deshoje') {
            // Validar ref
            ref = $(this).find('.ref').val();
            if (!ref || ref <= 0) {
                alert('Debe ingresar referencia válida en Deshoje');
                incompletas = true;
                return false;
            }
            // Validar cada cantidad
            let todosLlenos = true;
            $(this).find('.cant').each(function () {
                const v = parseFloat($(this).val());
                if (isNaN(v) || v <= 0) {
                    todosLlenos = false;
                    return false;
                }
            });
            if (!todosLlenos) { alert('Debe ingresar todas las cantidades de Deshoje'); incompletas = true; return false; }
            cantidad = promedio($(this).find('.cant'));

        } else if (actividad === 'Descorone') {
            let todosLlenos = true;
            $(this).find('.cant').each(function () {
                const v = parseFloat($(this).val());
                if (isNaN(v) || v <= 0) {
                    todosLlenos = false;
                    return false;
                }
            });
            if (!todosLlenos) { alert('Debe ingresar todas las cantidades de Descorone'); incompletas = true; return false; }
            cantidad = promedio($(this).find('.cant'));

        } else if (actividad === 'Ganchos') {
            const val = parseFloat($(this).find('.cant-unica').val());
            if (isNaN(val) || val <= 0) {
                alert('Debe ingresar cantidad válida en Ganchos');
                incompletas = true;
                return false;
            }
            cantidad = val;
        }

        datos.push({
            fecha,
            area,
            zona,
            estructura,
            cultivo,
            supervisor,
            actividad,
            ref,
            cantidad,
            observaciones: $(this).find('.obs').val(),
            status: 'Abierta'
        });
    });

    if (incompletas) {
        boton.prop('disabled', false);
        return;
    }

    // ====== ENVÍO ======
    console.log(datos);

    $.ajax({
        url: "{% url 'supervisionproduccion_grabar' %}",
        type: "POST",
        contentType: "application/json",
        headers: { "X-CSRFToken": getCookie('csrftoken') },
        data: JSON.stringify({ array: datos }),
        success: function (response) {
            alert(response.msm || 'Guardado correctamente');
            boton.prop('disabled', false);
            if (response.completo) {
                alert('✅ Muestra 10 registrada. El lote está completo');
                window.location.href = "{% url 'supervisionproduccion_list' %}";
            } else {
                alert('Muestra ' + response.muestra + ' registrada correctamente');
                $('#myTable input').val(''); // limpiar inputs
            }
        },
        error: function () {
            alert("Error al guardar");
            boton.prop('disabled', false);
        }
    });
});

});
</script>