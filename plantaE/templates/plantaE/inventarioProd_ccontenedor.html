<!DOCTYPE html>
<html>
{% load static %} 
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous">   

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css">
    <title>Carga Contenedores</title>
    <style>

          .inputs-row {
        display: flex;
        flex-wrap: nwrap; /* Para que se acomoden bien en pantallas más pequeñas */
            }
            
                h1 {
                    margin: 15px;
                    font-family: Arial, sans-serif;
                }

                a {
                    margin: 20px;
                    font-family: Arial, sans-serif;
                }
            /* Estilos generales para el botón input */
        .envio3 {
            background-color: #4CAF50;  /* Color de fondo verde */
            color: white;  /* Texto blanco */
            font-size: 16px;  /* Tamaño de fuente */
            padding: 12px 24px;  /* Espaciado alrededor del texto */
            border: none;  /* Sin borde */
            border-radius: 25px;  /* Bordes redondeados */
            cursor: pointer;  /* Aparece como cursor de mano */
            transition: all 0.3s ease;  /* Transición suave para los efectos */
            display: inline-flex;
            align-items: center;  /* Alineación vertical del texto e ícono */
            text-align: center; /* Centrar el texto en el input */
        }

        /* Efecto hover */
        .envio3:hover {
            background-color: #45a049;  /* Fondo verde más oscuro al pasar el mouse */
            transform: scale(1.05);  /* Ligeramente más grande */
        }

        /* Efecto de enfoque (cuando se hace clic en el botón) */
        .envio3:focus {
            outline: none;  /* Quitar el borde por defecto al hacer clic */
            box-shadow: 0 0 8px rgba(0, 128, 0, 0.5);  /* Sombra verde */
        }

        /* Si usas un ícono en el botón */
        .envio3 i {
            margin-right: 8px;  /* Separación entre el ícono y el texto */
        }

                /* Estilo general para los checkboxes dentro de la tabla */
        table .seleccionar {
            width: 20px;  /* Tamaño más pequeño y proporcional */
            height: 20px;
            border-radius: 4px;  /* Bordes redondeados */
            border: 2px solid #ddd;  /* Borde sutil */
            transition: background-color 0.3s ease, border-color 0.3s ease;
            background-color: #fff;  /* Fondo blanco */
            cursor: pointer;  /* Cursor tipo puntero para indicar que es clickeable */
        }

        /* Estilo cuando el checkbox está marcado */
        table .seleccionar:checked {
            background-color: #4CAF50;  /* Fondo verde cuando está marcado */
            border-color: #4CAF50;  /* Cambio de borde a verde */
        }

        /* Estilo cuando el checkbox está en foco */
        table .seleccionar:focus {
            outline: none;  /* Elimina el borde azul por defecto */
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);  /* Agrega sombra verde suave cuando tiene foco */
        }

        /* Para dar una apariencia personalizada de la casilla */
        table .seleccionar {
            -webkit-appearance: none;  /* Elimina el estilo por defecto en Webkit (Chrome, Safari) */
            -moz-appearance: none;  /* Elimina el estilo por defecto en Firefox */
            appearance: none;  /* Elimina el estilo por defecto en todos los navegadores */
            border-radius: 5px;  /* Bordes más redondeados */
            background-color: #fff;  /* Fondo blanco */
            width: 18px;
            height: 18px;
            border: 2px solid #bbb;  /* Borde gris claro */
            display: inline-block;  /* Hace que el checkbox se vea como un cuadro */
            position: relative;
        }

        /* Estilo cuando el checkbox está marcado con una paloma (check) */
        table .seleccionar:checked::before {
            content: '';  /* No necesita texto, solo la marca */
            position: absolute;
            top: 4px;
            left: 4px;
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 2px;
            border: solid 2px #fff;
            transform: rotate(45deg);  /* Rota para formar una "X" */
        }

                /* Estilo para el contenedor del select */
        #Conten {
            font-size: 16px;  /* Aumentamos el tamaño de fuente para mejor legibilidad */
            padding: 8px 12px;  /* Espaciado interno para un mejor clic */
            width: 100%;  /* Asegura que el select ocupe todo el ancho disponible */
            border: 2px solid #ddd;  /* Borde sutil de color gris */
            border-radius: 5px;  /* Bordes redondeados */
            background-color: #fff;  /* Fondo blanco */
            transition: all 0.3s ease;  /* Transición suave para cambios de estado */
            appearance: none;  /* Eliminar el estilo predeterminado en algunos navegadores */
        }

        /* Cambiar color de fondo y borde cuando el select está enfocado */
        #Conten:focus {
            border-color: #4CAF50;  /* Cambiar el borde a verde cuando se hace foco */
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);  /* Sombra verde suave */
            outline: none;  /* Eliminar borde de enfoque predeterminado */
        }

        /* Flecha personalizada para el select */
        #Conten::-ms-expand {
            display: none;  /* Eliminar la flecha por defecto en IE/Edge */
        }

        #Conten {
            background-image: url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2210%22 height=%2210%22 viewBox=%220 0 10 10%22%3E%3Cpath fill=%22none%22 stroke=%22#333%22 stroke-width=%22.8%22 d=%22M1 3l4 4 4-4%22/%3E%3C/svg%3E');
            background-position: right 10px center;
            background-repeat: no-repeat;
            padding-right: 30px;  /* Asegura que el contenido no se cubra con la flecha */
        }

        /* Mejorar la apariencia del dropdown cuando está abierto */
        #Conten:active, #Conten:focus {
            background-color: #f5f5f5;  /* Fondo ligeramente gris cuando se abre */
            border-color: #4CAF50;  /* Bordes verdes */
        }

        /* Estilo para la lista de opciones dentro del select */
        #Conten option {
            padding: 10px;
            font-size: 14px;
            color: #333;  /* Color de texto */
            background-color: #fff;  /* Fondo blanco */
            transition: background-color 0.3s ease;  /* Transición suave al cambiar el fondo */
        }

        /* Resaltar la opción seleccionada */
        #Conten option:checked {
            background-color: #4CAF50;  /* Fondo verde para opción seleccionada */
            color: white;  /* Texto blanco cuando se selecciona */
        }

        /* Estilo para el select cuando no tiene valor */
        #Conten option:first-child {
            color: #888;  /* Color gris claro para la opción predeterminada */
        }
        .half {
        display: flex;
        height: 100%;
        grid-template-columns:  repeat(auto-fit, minmax(min-content, max-content)); /* Divide cada mitad en dos columnas iguales */
        gap: 5px; /* Espacio entre columnas */
        text-align: center;
        }

        .box {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 10px;
            flex: auto; 
            height: 100%;    
        }

        /* Estilo para el input de tipo fecha */
input[type="date"] {
    width: 100%;  /* Asegura que el input ocupe todo el ancho disponible dentro de su contenedor */
    max-width: 250px;  /* Limita el ancho máximo del campo de fecha */
    padding: 10px;  /* Ajusta el espacio dentro del input */
    font-size: 14px;  /* Ajusta el tamaño de la fuente */
    text-align: center;  /* Alinea el texto de la fecha al centro */
    border: 1px solid #ddd;  /* Borde sutil */
    border-radius: 5px;  /* Bordes redondeados */
    background-color: #fff;  /* Fondo blanco */
    transition: all 0.3s ease;  /* Transición suave para el enfoque */
}

input[type="date"]:focus {
    border-color: #4CAF50;  /* Cambia el borde a verde cuando está en foco */
    box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);  /* Agrega una sombra suave cuando está enfocado */
    outline: none;  /* Elimina el borde de enfoque predeterminado */
}

        /* Estilo general para el campo de fecha */
#date {
    width: 100%;  /* Asegura que ocupe el ancho completo del contenedor */
    padding: 10px 12px;  /* Espaciado interno */
    font-size: 16px;  /* Tamaño de fuente */
    border: 1px solid #ddd;  /* Borde suave */
    border-radius: 5px;  /* Bordes redondeados */
    background-color: #fff;  /* Fondo blanco */
    transition: all 0.3s ease;  /* Transición suave para el enfoque */
    -webkit-appearance: none;  /* Elimina el estilo predeterminado en Webkit (Chrome, Safari) */
    -moz-appearance: none;  /* Elimina el estilo predeterminado en Firefox */
    appearance: none;  /* Elimina el estilo predeterminado en todos los navegadores */
}

/* Cambio de estilo cuando el campo tiene foco (cuando está seleccionado) */
#date:focus {
    border-color: #4CAF50;  /* Borde verde cuando se hace foco */
    box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);  /* Sombra verde suave */
    outline: none;  /* Eliminar el borde azul predeterminado */
}

/* Opcional: Personalización del ícono de calendario */
#date::-webkit-calendar-picker-indicator {
    background-image: url('https://upload.wikimedia.org/wikipedia/commons/3/3b/Calendar_icon_%28web%29.svg');
    background-size: 18px;
    background-repeat: no-repeat;
    background-position: center;
}

    </style>
</head>
<body>
    <h1 class="roboto">Panel</h1>
    <br>
    <div class = "container"> 
        <div class="half">

            <div class="box">
                <a href="{% url 'inventarioProd_packinglist' %}">Consulta OV</a> 
            </div>
        </div>   
    </div>
    <div class = "container"> 
        <div class="half">
            <div class="box">
                <form>
                    <div><label for="contenedor">Contenedor:</label></div>
                    <div class="select"> 
                        <select name="contenedor" id="Conten">
                        </select>
                    </div>
                </form>      
            </div>
            <div class="box">
                <form>
                    <div><label for="fecha">Fecha - Produccion:</label></div>
                    <div>
                        <input class="input" id="date" type="date" value={{fecha}}>
                    </div>
                </form>      
            </div>
        </div>
    </div>

    <div class="container">
        <div class="columns">
            <div class="column is-12">
            <div class="table-container">
                <table class="table is-striped is-hoverable is is-fullwidth" id="myTable">
                <thead id = "enc1">
                    <tr class="header">
                    <th >Proveedor</th>
                    <th >Cultivo</th>
                    <th >itemSAPCode</th>
                    <th >itemSAPName</th>
                    <th >Cajas</th>
                    <th >Libras</th>
                    <th >Seleccionar</th>
                    <th >Eliminar</th>
                    </tr>
                </thead>
                <tbody>
                {%for registro in registros %} 
                <tr> 
                    <td>{{registro.proveedor}}</td>
                    <td>{{registro.cultivo}}</td>
                    <td>{{registro.itemsapcode}}</td>
                    <td>{{registro.itemsapname}}</td>
                    <td><div contenteditable="true" class="editable-cell">{{registro.cajas_restantes}}</div></td>
                    <td><div>{{registro.libras_restantes}}</div></td>
                    <td><input type="checkbox" class="seleccionar"></td>
                   <td><button class="eliminar"><i class="fas fa-trash-alt"></i></button></td>
                    </tr> 
                        
                {% endfor %}
                </tbody>
                <tr id="totalRow">
                    <td colspan="7" style="text-align: right; font-weight: bold;">Total:</td>
                    <td id="totalCajas">0</td>
                    <td colspan="3"></td> <!-- Espacio para las otras columnas -->
                </tr>
                </table>
            </div>
            </div>
        </div>
        </div>
        <br>
        <div class = "container"> 
            <div class="half">
                <div class="box">
                    <form>
                        <div>
                            <input type="button" value="Enviar" class="envio3">
                        </div>
                    </form>      
                </div>
            </div>
        </div>
</body>
<script type="text/javascript" src="{% static '/lib/cockies.js' %}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

const eliminarBotones = document.querySelectorAll('.eliminar');

$(document).on('click', '.eliminar', function() {
    $(this).closest('tr').remove();
});

</script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<script>

    $(document).ready(function() {
        $('#myTable').DataTable();
    });

</script>

<script>
    $(document).ready(function() {
        console.log("Página cargada");
    
        // Función para cargar contenedores
        function loadProducts() {
            console.log("Cargando contenedores...");
            $.ajax({
                url: '{% url "load_contenedores" %}',  // URL para la vista AJAX
                data: {
                    'category_id': 'Consulta' // Envia el ID de la categoría como parámetro
                },
                success: function(data) {
                    console.log("Datos recibidos:", data);
                    $('#date').val(data.fecha);
                    // Limpia las opciones actuales del campo 'select'
                    $('#Conten').html('');
                    $('#Conten').append(
                        $('<option>').text('Seleccione un contenedor').attr('value', '')
                    );
                    
                    // Recorre los productos recibidos y añade opciones al campo 'select'
                    $.each(data.adicionales, function(index, product) {
                        $('#Conten').append(
                            $('<option>').text(product.contenedor.toString()).attr('value', product.contenedor.toString())
                        );
                    });
                    // Verificar si hay un contenedor guardado en localStorage
                    var selectedContenedor = localStorage.getItem('selectedContenedor');
                   
                    if (selectedContenedor !== null && selectedContenedor !== '' ) {
                        // Si el valor existe en localStorage, seleccionar el contenedor
                        $('#Conten').val(selectedContenedor);  // Seleccionar el contenedor guardado
                    } else {
                        // Si no existe un valor en localStorage, puedes dejar el select vacío o con un valor predeterminado
                        $('#Conten').val('');  // O puedes poner otro valor predeterminado si lo prefieres
                    }
    
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);  // Maneja errores de la solicitud
                }
            });
        }
    
        // Llamar a la función de carga de contenedores
        loadProducts();

            // Función que actualiza el total de cajas
        function updateTotal() {
            var totalCajas = 0;
            
            // Recorre todas las filas que están seleccionadas (marcadas con checkbox)
            $('input[type="checkbox"]:checked').each(function() {
                var row = $(this).closest('tr');  // Encuentra la fila correspondiente
                var cajas = parseFloat(row.find('td').eq(4).find('.editable-cell').text()) || 0;  // Obtenemos el valor de la columna "Cajas" (índice 6) desde .editable-cell
                totalCajas += cajas;  // Acumula el total de cajas
            });

            // Actualiza el total en la fila correspondiente
            $('#totalCajas').text(totalCajas);  // Muestra el total en la fila de suma
        }

        // Cuando se marque o desmarque un checkbox
        $(document).on('change', 'input[type="checkbox"]', function() {
            updateTotal();  // Llama a la función para actualizar el total
        });

        // Inicializa el total al cargar la página
        updateTotal();

        $('.envio3').on('click', function() {
    var resume_table = document.getElementById("myTable");
    var datos = [];

    // Iterar sobre las filas de la tabla (empezando desde la fila 1 para saltar el encabezado)
    for (var i = 1, row; row = resume_table.rows[i]; i++) {
        var checkbox = row.querySelector('input[type="checkbox"]');  // Obtener el checkbox en esta fila

        // Si el checkbox está marcado, recolectamos los datos de la fila
        if (checkbox && checkbox.checked) {
            var filas = [];

            // Recorremos las celdas de la fila
            for (var j = 0, col; col = row.cells[j]; j++) {
                // Si la columna contiene una fecha, formatearla
                if (col.innerText.match(/^[A-Za-z]{3}\.\s\d{1,2},\s\d{4}$/)) { // Coincide con el formato "Oct. 10, 2024"
                    // Convertir la fecha
                    var fechaOriginal = col.innerText;
                    var fechaConvertida = new Date(fechaOriginal).toISOString().split('T')[0];
                    filas.push(fechaConvertida);
                } else {
                    filas.push(col.innerText);
                }
            }

            // Añadir la información del contenedor seleccionado
            var conten = document.getElementById('Conten'),
                value_conten = conten.value,
                text_conten = conten.options[conten.selectedIndex].innerText;
            var fecha = document.getElementById('date').value;
            filas.push(text_conten);
            // Guardar el valor del contenedor en localStorage antes de recargar la página
            localStorage.setItem('selectedContenedor', text_conten);
            filas.push(fecha);
            // Guardamos la fila seleccionada
            datos.push(filas);
            
            
        }
    }

    // Enviar los datos seleccionados a través de AJAX
    console.log(datos);

    $.ajax({
        url: '{% url "inventarioProd_contprocessv2" %}',  // URL para la vista AJAX
        type: 'POST',
        dataType: "json",
        data: JSON.stringify({'array': datos, 'contenedor': text_conten}),
        contentType: 'application/json',
        headers: {'X-CSRFToken': csrftoken},

        success: function(data) {
            alert("Palet " + data.palet + " agregado a contenedor");

            // Si palet es 20, entonces resetear y redirigir
            if (data.palet === 20) {
                alert("Se completó contenedor.");
                // Resetear contenedor, puedes hacerlo de esta forma si lo deseas:
                localStorage.removeItem('selectedContenedor');  // Elimina el valor del contenedor del localStorage
                $('#Conten').val('');  // Opcional: limpiar el contenedor seleccionado
                window.location.replace('https://sdc-iot.popoyan.com.gt/plantaE/inventarioProd/packinglist'); // Redirigir
            } else {
                // Si el palet es menor a 20, recargar la página pero mantener el contenedor seleccionado
                //loadProducts(); // Recargar los contenedores disponibles
                //$('#Conten').val(text_conten); // Mantener el contenedor seleccionado
                location.reload(); // Recargar la página sin perder el contenedor
            }

            console.log(data);
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
        }
    });
});

    });
    </script>
    
</html>