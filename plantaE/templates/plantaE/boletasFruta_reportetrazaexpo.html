<!DOCTYPE html>
<html lang="es">
{% load static %}
<head>
  <meta charset="UTF-8">
  <title>Panel - totalFruta</title>

  <!-- Bulma CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      background-color: #f9f9f9;
    }
    .panel-header {
      margin-bottom: 1.5rem;
    }
    .filters {
      background: white;
      padding: 1.5rem;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .data-section {
      margin-top: 2rem;
    }
    .box {
      border-radius: 6px;
    }
    .back-link {
      margin-top: 2rem;
      display: inline-block;
    }
    .is-small-text {
      font-size: 0.9rem;
      color: #777;
    }
    .table-custom-header th {
    background: linear-gradient(to right, #6c757d, #495057);
    color: white !important;
    font-weight: 600;
    text-align: center;
    white-space: nowrap;
    }
  </style>
</head>
<body>
  <section class="section">
    <div class="container">
      <!-- HEADER -->
        <section class="hero is-success is-small mb-5">
        <div class="hero-body">
            <div class="container has-text-centered">
            <h1 class="title is-3 has-text-white">Panel de Control</h1>
            <p class="subtitle is-6 has-text-white-ter">Consulta de salidas de fruta</p>
            </div>
        </div>
        </section>
      <div class="filters box">
        <form id="filtros">
          <div class="columns is-variable is-4">
            <div class="column is-3">
              <label class="label" for="date">Fecha</label>
              <input
                id="date"
                class="input"
                type="date"
                value="{{ fecha }}"
                name="date"
              />
            </div>
            
            <div class="column is-3">
              <label class="label" for="Contenedor">Contenedor</label>
              <div class="select is-fullwidth">
                <select id="Contenedor" name="Contenedor">
                  <option value="">Seleccionar contenedor</option>
                </select>
              </div>
            </div>
            <div class="column is-3">
              <label class="label" for="Cultivo">Cultivo</label>
              <div class="select is-fullwidth">
                <select id="Cultivo" name="Cultivo">
                  
                  <option value="">Seleccionar cultivo</option>
                </select>
              </div>
            </div>
            <div class="column is-2 is-flex is-align-items-end">
              <button type="button" id="consultar" class="button is-success is-fullwidth">
                <span class="icon"><i class="fas fa-search"></i></span>
                <span>Consultar</span>
              </button>
              <button type="button" id="packing" class="button is-info is-fullwidth mt-2">
                <i class="fas fa-file-invoice"></i> Packing List
            </button>
            </div>
          </div>
        </form>
      </div>

      <!-- TABLA 1 -->
      <div class="data-section">
        <div class="box">
          <h2 class="title is-5">Detalle por variedad</h2>
          <div class="table-container">
            <table class="table is-striped is-fullwidth is-hoverable" id="myTable">
              <thead class="table-custom-header">
                <tr>
                  <th>Fecha</th>
                  <th>Palet</th>
                  <th>Productor</th>
                  <th>Cultivo</th>
                  <th>ItemSAPCode</th>
                  <th>ItemSAPNombre</th>
                  <th>Cajas</th>
                  <th>Libras</th>
                  <th>Constancia</th>
                </tr>
              </thead>
              <tbody>
                {% for registro in registros %}
                <tr>
                  <td>{{ registro.fecha }}</td>
                  <td>{{ registro.palet }}</td>
                  <td>{{ registro.cultivo }}</td>
                  <td>{{ registro.productor }}</td>
                  <td>{{ registro.itemsap_code }}</td>
                  <td>{{ registro.itemsap_name  }}</td>
                  <td class="number-cell" data-value="{{ registro.cajas }}">{{ registro.cajas  }}</td>
                  <td class="number-cell" data-value="{{ registro.libras }}">{{ registro.libras }}</td>
                  <td></td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot id="totalesRow"></tfoot>
            </table>
          </div>
        </div>
      </div>


    <div class="has-text-centered mt-6">
        <a href="{% url 'plantaE_home' %}" class="button is-success is-medium is-rounded">
            <span class="icon">
            <i class="fas fa-home"></i>
            </span>
            <span>Home</span>
        </a>
    </div>
    </div>
  </section>

  <!-- SCRIPTS -->
  <script src="{% static '/lib/cockies.js' %}"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    // Variables globales
    window.vector1 = [];
    window.vector2 = [];
    // CONSULTAR
    document.getElementById('consultar').addEventListener('click', function () {
      const contenedor = document.getElementById('Contenedor').value;
      const tbody = document.querySelector('#myTable tbody');

      tbody.innerHTML = '';

      fetch('{% url "boletasFruta_reportetrazaexpo" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: new URLSearchParams({
          'opcion1': contenedor,
          'opcion2': document.getElementById('date').value,
          'opcion3': document.getElementById('Cultivo').value
        })
      })
        .then(response => response.json())
        .then(data => {
          console.log(data)
          if (!data.datos) {
            console.warn("No se encontraron datos.");
            return;
          }
          let sumaCajas = 0;
let sumaLibras = 0;

data.datos.forEach(item => {

    sumaCajas += Number(item.total_cajas);
    sumaLibras += Number(item.total_libras);

    const row = `<tr>
      <td>${item.fecha}</td>
      <td>${item.palet}</td>
      <td>${item.proveedor}</td>
      <td>${item.cultivo}</td>
      <td>${item.itemsapcode}</td>
      <td>${item.itemsapname}</td>
      <td>${Math.round(item.total_cajas)}</td>
      <td>${Math.round(item.total_libras)}</td>
      <td>
        <button 
          class="button is-small is-link imprimir-btn"
          data-fecha="${item.fecha}"
          data-palet="${item.palet}"
          data-proveedor="${item.proveedor}"
          data-cultivo="${item.cultivo}"
          data-itemsapcode="${item.itemsapcode}"
          data-itemsapname="${item.itemsapname}"
          data-total_cajas="${item.total_cajas}"
          data-total_libras="${item.total_libras}"
        >
          <i class="fas fa-print"></i>
        </button>
      </td>
    </tr>`;
    tbody.insertAdjacentHTML('beforeend', row);
});

// Agregar totales al footer
document.getElementById('totalesRow').innerHTML = `
<tr style="background:#d9fdd3; font-weight:bold;">
    <td colspan="6" style="text-align:right;">TOTAL:</td>
    <td>${sumaCajas.toLocaleString('es-ES')}</td>
    <td>${sumaLibras.toLocaleString('es-ES')}</td>
    <td></td>
</tr>`;

          formatCells('myTable');
        });
    });

    // CARGA INICIAL
    $(document).ready(function () {
      $.ajax({
        url: '{% url "obtener_nombre_usuario" %}',
        data: { 'category_id': 'Consulta' },
        success: function (data) {
          $('#date').val(data.fecha);
        },
        error: function (xhr, status, error) {
          console.error('Error al cargar usuario:', error);
        }
      });
    });

    // FORMATEO DE NÚMEROS
    function formatCells(tableId) {
      const cells = document.querySelectorAll(`#${tableId} td.number-cell`);
      cells.forEach(cell => {
        const value = Number(cell.getAttribute('data-value'));
        if (!isNaN(value)) {
          cell.textContent = value.toLocaleString('es-ES');
        }
      });
    }
    
    // Cuando cambia el contenedor, cargar cultivos disponibles dentro de ese contenedor
$('#Contenedor').change(function () {
    const contenedor = $(this).val();
    const fecha = $('#date').val();

    if (!contenedor || !fecha) return;

    $.ajax({
        url: '{% url "load_dataUsuario9" %}', // vista nueva
        data: {
            'contenedor': contenedor,
            'fecha': fecha
        },
        success: function (data) {
            console.log("Cultivos recibidos:", data);

            $('#Cultivo').html('<option value="">Seleccionar cultivo</option>');

            if (data.cultivos.length === 0) {
                alert("Este contenedor no tiene cultivos registrados.");
                return;
            }

            data.cultivos.forEach(c => {
                $('#Cultivo').append(`<option value="${c}">${c}</option>`);
            });
        },
        error: function (xhr) {
            console.error("Error cargando cultivos:", xhr);
        }
    });
});



    function loadProducts(categoryId) {
        $.ajax({
            url: '{% url "load_dataUsuario8" %}',  // URL para la vista AJAX
            data: {
                'fechareporte':document.getElementById('date').value,
                'cultivo':categoryId
            },
            success: function(data) {
                // Limpia las opciones actuales del campo 'name'
                console.log(data);
                if (data.contenedores.length === 0) {
                    alert(data.mensaje || 'No se encontraron envíos.');
                } else {
                    $('#Contenedor').html('');
                    $('#Contenedor').html('<option value="">Seleccionar contenedor</option>');
                    // Recorre los productos recibidos y añade opciones al campo 'name'
                    data.contenedores.forEach(item => {
                      $('#Contenedor').append(`<option value="${item}">${item}</option>`);
                    });
                }
                
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);  // Maneja errores de la solicitud
            }
        });
    }
    document.addEventListener('DOMContentLoaded', () => {
      formatCells('myTable');
      
    });

// Cuando cambia la fecha, cargar contenedores
$('#date').change(function () {
    const fecha = $(this).val();
    $('#Contenedor').html('<option>...</option>');
    $('#Cultivo').html('<option value="">Seleccionar cultivo</option>');

    if (!fecha) return;

    $.ajax({
        url: '{% url "load_dataUsuario8" %}',  
        data: {
            'fechareporte': fecha,
            'cultivo': ''  
        },
        success: function (data) {
            $('#Contenedor').html('<option value="">Seleccionar contenedor</option>');

            if (data.contenedores.length === 0) {
                alert('No se encontraron contenedores para esa fecha.');
                return;
            }

            data.contenedores.forEach(item => {
                $('#Contenedor').append(`<option value="${item}">${item}</option>`);
            });
        }
    });
});
                                                         
document.addEventListener('click', function(e) {
  const btn = e.target.closest('.imprimir-btn');
  if (!btn) return;

  const fecha = btn.dataset.fecha;
  const palet = btn.dataset.palet;
  const itemsapcode = btn.dataset.itemsapcode;
  const itemsapname = btn.dataset.itemsapname;
  const total_cajas = btn.dataset.total_cajas;
  const total_libras = btn.dataset.total_libras;
  const proveedor= btn.dataset.proveedor;
  
  const cultivo = btn.dataset.cultivo;
  const contenedor = document.getElementById('Contenedor').value;
 
  // Aquí usas variables globales o los datos que ya tengas cargados (vectores)
  
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '{% url "boletasFruta_constanciatrazaexpo" %}';
  form.target = '_blank';

  // CSRF token
  const csrfToken = getCookie('csrftoken'); // función para leer cookie CSRF
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrfmiddlewaretoken';
  csrfInput.value = csrfToken;
  form.appendChild(csrfInput);

  // Añadir los campos
  const data = {
    fecha, palet,total_libras, itemsapcode, itemsapname,
     total_cajas, proveedor,cultivo,contenedor
  };

  for (const [key, val] of Object.entries(data)) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = key;
    input.value = val;
    form.appendChild(input);
  }

  document.body.appendChild(form);
  form.submit();
  document.body.removeChild(form);
});


document.getElementById("packing").addEventListener("click", function () {

    const fecha = document.getElementById('date').value;
    const contenedor = document.getElementById('Contenedor').value;
    const cultivo = document.getElementById('Cultivo').value;

    if (!fecha || !contenedor) {
        alert("Selecciona fecha y contenedor primero.");
        return;
    }

    // Crear formulario para abrir en nueva pestaña
    const form = document.createElement("form");
    form.method = "POST";
    form.action = "{% url 'generate_packing_list_pdf' %}";
    form.target = "_blank";

    // CSRF
    const csrf = document.createElement("input");
    csrf.type = "hidden";
    csrf.name = "csrfmiddlewaretoken";
    csrf.value = getCookie("csrftoken");
    form.appendChild(csrf);

    // Enviar valores
    const fields = { fecha, contenedor, cultivo };

    Object.entries(fields).forEach(([k, v]) => {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = k;
        input.value = v;
        form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
    form.remove();
});

  </script>
  
</body>
</html>