<!DOCTYPE html>
<html lang="es">
{% load static %}
<head>
  <meta charset="UTF-8" />
  <title>Panel - inventarioFruta</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      background-color: #f9f9f9;
    }
    .table-custom-header th {
      background: linear-gradient(to right, #6c757d, #495057);
      color: white !important;
      font-weight: bold;
      text-align: center;
    }
    .is-stretch {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .is-stretch > .field {
      flex: 1;
      min-width: 180px;
    }
    .content-controls {
      margin-top: 2rem;
    }
    .mb-1 {
      margin-bottom: 1rem;
    }
  </style>
</head>

<body>
  <section class="section">
    <div class="container">

      <!-- HEADER -->
      <section class="hero is-success is-small mb-5">
        <div class="hero-body">
          <div class="container has-text-centered">
            <h1 class="title is-3 has-text-white">Panel de Control</h1>
            <p class="subtitle is-6 has-text-white-ter">Gestión de ingreso de inventario de fruta</p>
          </div>
        </div>
      </section>

      <!-- FILTROS -->
      <div class="filters">
        <form id="filtros">
          <div class="is-stretch">
            <div class="field">
              <label class="label" for="date">Fecha</label>
              <input class="input" type="date" id="date" value="{{ fecha }}">
            </div>

            <div class="field">
              <label class="label" for="Pro">Proveedor</label>
              <div class="select is-fullwidth">
                <select id="Pro">
                  <option value="">Seleccionar</option>
                  <option value="SDC">SDC</option>
                  <option value="INVERNADEROS TECNOLOGICOS S.A">INVERNADEROS TECNOLOGICOS S.A</option>
                  <option value="PRODUCTOS DEL VALLE, S.A.">PRODUCTOS DEL VALLE, S.A.</option>
                  <option value="HORTEX, S.A.">HORTEX, S.A.</option>
                  <option value="DANIEL ESTUARDO GALICIA CARRERA">DANIEL ESTUARDO GALICIA CARRERA</option>
                  <option value="INVERSIONES LA PASTORIA, S.A.">INVERSIONES LA PASTORIA, S.A.</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label class="label" for="Cul">Cultivo</label>
              <div class="select is-fullwidth">
                <select id="Cul">
                  <option value="">Seleccionar</option>
                  <option value="BLOCKY ORGANICO">BLOCKY ORGANICO</option>
                  <option value="BLOCKY">BLOCKY</option>
                  <option value="CHERRY">CHERRY</option>
                  <option value="GRAPE">GRAPE</option>
                  <option value="MEDLEY">MEDLEY</option>
                  <option value="GRAPE ORGANICO">GRAPE ORGANICO</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label class="label" for="Cat">Categoría</label>
              <div class="select is-fullwidth">
                <select id="Cat">
                  <option value="">Seleccionar</option>
                  <option value="Exportación">Exportación</option>
                  <option value="Carreta">Carreta</option>
                  <option value="Cenma">Cenma</option>
                  <option value="Devolución">Devolución</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label class="label" for="correo">Usuario</label>
              <input class="input" type="text" id="correo" value="{{ usuario }}" readonly>
            </div>
          </div>
        </form>
      </div>

      <!-- BOTÓN CONSULTAR ARRIBA DE LA TABLA -->
      <div class="mb-1">
        <button id="consultar" type="button" class="button is-success">
          <span class="icon"><i class="fas fa-search"></i></span>
          <span>Consultar</span>
        </button>
      </div>

      <!-- TABLA -->
      <div class="box">
        <div class="table-container">
          <table class="table is-striped is-hoverable is-fullwidth" id="myTable">
            <thead class="table-custom-header">
              <tr>
                <th>ItemSAPCode</th>
                <th>ItemName</th>
                <th>Cajas</th>
                <th>Libras</th>
                <th>Eliminar</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- BOTONES FINALES -->
    <div class="columns content-controls">
    <div class="column is-6">
        <a href="{% url 'inventarioProd_list' %}" class="button is-success is-medium is-fullwidth">
        <span class="icon"><i class="fas fa-home"></i></span>
        <span>Ir al Home</span>
        </a>
    </div>
    <div class="column is-6 has-text-right">
        <button type="button" class="button is-success is-medium is-fullwidth envio3">
        <span class="icon"><i class="fas fa-paper-plane"></i></span>
        <span>Enviar</span>
        </button>
    </div>
    </div>
  </section>

<script type="text/javascript" src="{% static '/lib/cockies.js' %}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<script>
let dataTable;  // Declaración global

$(document).ready(function() {
    // Inicializa la tabla una sola vez
    dataTable = $('#myTable').DataTable({
        pageLength: 20,
        lengthMenu: [5, 10, 20, 25, 50, 100],
        language: {
            lengthMenu: "Mostrar _MENU_ entradas",
            zeroRecords: "No se encontraron resultados",
            info: "Mostrando _START_ a _END_ de _TOTAL_ entradas",
            infoEmpty: "Mostrando 0 a 0 de 0 entradas",
            infoFiltered: "(filtrado de _MAX_ entradas totales)",
            search: "Buscar:",
            paginate: {
                first: "Primero",
                last: "Último",
                next: "Siguiente",
                previous: "Anterior"
            },
        }
    });

    // Consultar y cargar datos a la tabla
    document.getElementById('consultar').addEventListener('click', function() {
        const opcionSeleccionada1 = document.getElementById('Cul').value;
        const opcionSeleccionada2 = document.getElementById('Cat').value;
        console.log(opcionSeleccionada1);
        console.log(opcionSeleccionada2);

        fetch('{% url "inventarioProd_create" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: new URLSearchParams({
                'opcion1': opcionSeleccionada1,
                'opcion2': opcionSeleccionada2
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);

            // Mapeamos los datos para el DataTable
            const rows = data.datos.map(item => {
                return [
                    item.itemsapcode,
                    item.calidad1,
                    '<div contenteditable="true" class="editable-cell"></div>',
                    '<div contenteditable="true" class="editable-cell"></div>',
                    `<button class="button is-small is-danger is-light eliminar" title="Eliminar fila">
                        <span class="icon is-small"><i class="fas fa-trash-alt"></i></span>
                    </button>`
                ];
            });

            // Limpia y carga los nuevos datos
            dataTable.clear().rows.add(rows).draw();
        });
    });

    // Eliminar fila (delegated event)
    $(document).on('click', '.eliminar', function() {
        dataTable.row($(this).closest('tr')).remove().draw();
    });

    // ENVÍO de datos
    $('.envio3').on('click', function() {

      const boton = $(this);
      boton.prop('disabled', true); 
      const fecha = document.getElementById('date').value;
      const correo = document.getElementById('correo').value;
      let datos = [];

      dataTable.rows().every(function(rowIdx, tableLoop, rowLoop) {
          const row = this.node();
          const cells = $(row).find('td');

          const itemCode = cells.eq(0).text();
          const itemName = cells.eq(1).text();
          const cajas = parseFloat(cells.eq(2).text()) || 0;
          const libras = parseFloat(cells.eq(3).text()) || 0;

          // ❗ Solo incluir si ambos valores son mayores que cero
          if (cajas > 0 && libras > 0) {
              const prov = document.getElementById('Pro');
              const text_prov = prov.options[prov.selectedIndex].innerText;

              const cult = document.getElementById('Cul');
              const text_cult = cult.options[cult.selectedIndex].innerText;

              const cat = document.getElementById('Cat');
              const text_cat = cat.options[cat.selectedIndex].innerText;

              const fila = [itemCode, itemName, cajas, libras, text_prov, text_cult, text_cat, fecha, correo];
              datos.push(fila);
          }
      });

      console.log("Filas válidas a enviar:", datos);

      if (datos.length === 0) {
          alert("No hay datos válidos para enviar (requiere cajas y libras > 0).");
          return;
      }

      $.ajax({
          url: '{% url "inventarioProd_grabar" %}',
          type: 'POST',
          dataType: "json",
          data: JSON.stringify({ 'array': datos }),
          contentType: 'application/json',
          headers: { 'X-CSRFToken': getCookie('csrftoken') },

          success: function(data) {
              alert(data.msm);
              console.log(data);
              boton.prop('disabled', false);
          },
          error: function(xhr, status, error) {
              console.error('Error:', error);
              boton.prop('disabled', false);
          }
      });
  });


    // Autenticación del usuario al cargar
    function authUsuario() {
        $.ajax({
            url: '{% url "obtener_nombre_usuario" %}',
            data: { 'category_id': "Consulta" },
            success: function(data) {
                $('#date').val(data.fecha);
                $('#correo').val(data.encargado);
                loadProducts(data.username);
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
            }
        });
    }

    function loadProducts(categoryId) {
        $.ajax({
            url: '{% url "load_dataUsuario" %}',
            data: { 'category_id': categoryId },
            success: function(data) {
                $.each(data.datos, function(index, product) {
                    $('#Lug').append(
                        $('<option>').text(product.finca).val(product.finca)
                    );
                });
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
            }
        });
    }

    authUsuario();
});
</script>

</body>
</html>
