<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Planta</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f8f9fa; }
        .card-title { font-weight: bold; }
        .card-text { font-size: 1.8rem; }
    </style>
</head>
<body>

<div class="container my-4">
    <h1 class="text-center mb-4">Dashboard de Planta</h1>

    <!-- Cards de variables -->
    <div class="row text-center g-3">
        <div class="col-md-3">
            <div id="cardTemp" class="card text-white">
                <div class="card-body" style="background-color: #FF4C4C;">
                    <h5 class="card-title">Temperatura</h5>
                    <p class="card-text"><span id="temperatura">{{ latest.temperatura }}</span> °C</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div id="cardHumedadA" class="card text-white" style="background-color: #4C6EFF;">
                <div class="card-body">
                    <h5 class="card-title">Humedad Ambiente</h5>
                    <p class="card-text"><span id="humedad_aire">{{ latest.humedad_aire }}</span> %</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div id="cardHumedadS" class="card text-white" style="background-color: #28A745;">
                <div class="card-body">
                    <h5 class="card-title">Humedad Suelo</h5>
                    <p class="card-text"><span id="humedad_suelo">{{ latest.humedad_suelo }}</span> %</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div id="cardPeso" class="card text-dark" style="background-color: #FFC107;">
                <div class="card-body">
                    <h5 class="card-title">Peso Planta</h5>
                    <p class="card-text"><span id="peso">{{ latest.peso }}</span> kg</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gráfica -->
<div class="container my-5">
    <canvas id="sensoresChart" height="200"></canvas>
    <div class="text-center text-muted my-2">
        Última actualización: <span id="timestamp">{{ latest.timestamp }}</span>
    </div>
</div>

<script>
let timestamps = {{ timestamps|safe }};
let temperatura = {{ temperatura|safe }};
let humedad_aire = {{ humedad_aire|safe }};
let humedad_suelo = {{ humedad_suelo|safe }};
let peso = {{ peso|safe }};

// Crear gráfica
const ctx = document.getElementById('sensoresChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: timestamps,
        datasets: [
            { label: 'Temperatura (°C)', data: temperatura, borderColor: '#FF4C4C', backgroundColor: 'rgba(255,76,76,0.2)', tension: 0.3, yAxisID: 'y' },
            { label: 'Humedad Ambiente (%)', data: humedad_aire, borderColor: '#4C6EFF', backgroundColor: 'rgba(76,110,255,0.2)', tension: 0.3, yAxisID: 'y1' },
            { label: 'Humedad Suelo (%)', data: humedad_suelo, borderColor: '#28A745', backgroundColor: 'rgba(40,167,69,0.2)', tension: 0.3, yAxisID: 'y1' },
            { label: 'Peso (kg)', data: peso, borderColor: '#FFC107', backgroundColor: 'rgba(255,193,7,0.2)', tension: 0.3, yAxisID: 'y2' }
        ]
    },
    options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: { legend: { position: 'top' } },
        scales: {
            y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Temperatura (°C)' } },
            y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Humedad (%)' }, grid: { drawOnChartArea: false } },
            y2: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Peso (kg)' }, grid: { drawOnChartArea: false } }
        }
    }
});

// Función para actualizar colores dinámicamente según rango
function actualizarColores() {
    let temp = parseFloat(document.getElementById('temperatura').innerText);
    let humA = parseFloat(document.getElementById('humedad_aire').innerText);
    let humS = parseFloat(document.getElementById('humedad_suelo').innerText);

    // Temperatura: rojo si >30, naranja 25-30, azul <25
    let cardTemp = document.getElementById('cardTemp');
    if(temp > 30) cardTemp.style.backgroundColor = '#FF4C4C';
    else if(temp >= 25) cardTemp.style.backgroundColor = '#FF9F43';
    else cardTemp.style.backgroundColor = '#4C6EFF';

    // Humedad suelo: verde si 40-60, amarillo <40, azul >60
    let cardHumS = document.getElementById('cardHumedadS');
    if(humS < 40) cardHumS.style.backgroundColor = '#FFC107';
    else if(humS <= 60) cardHumS.style.backgroundColor = '#28A745';
    else cardHumS.style.backgroundColor = '#4C6EFF';
}

// Función para actualizar datos cada 60 segundos
async function actualizarDatos() {
    const response = await fetch("{% url 'dashboard' %}");
    const html = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    // Actualizar valores
    document.getElementById('temperatura').innerText = doc.getElementById('temperatura').innerText;
    document.getElementById('humedad_aire').innerText = doc.getElementById('humedad_aire').innerText;
    document.getElementById('humedad_suelo').innerText = doc.getElementById('humedad_suelo').innerText;
    document.getElementById('peso').innerText = doc.getElementById('peso').innerText;
    document.getElementById('timestamp').innerText = doc.getElementById('timestamp').innerText;

    // Actualizar gráfica
    chart.data.labels = JSON.parse(doc.querySelector('script').innerText.match(/timestamps = (.*);/)[1]);
    chart.data.datasets[0].data = JSON.parse(doc.querySelector('script').innerText.match(/temperatura = (.*);/)[1]);
    chart.data.datasets[1].data = JSON.parse(doc.querySelector('script').innerText.match(/humedad_aire = (.*);/)[1]);
    chart.data.datasets[2].data = JSON.parse(doc.querySelector('script').innerText.match(/humedad_suelo = (.*);/)[1]);
    chart.data.datasets[3].data = JSON.parse(doc.querySelector('script').innerText.match(/peso = (.*);/)[1]);
    chart.update();

    actualizarColores();
}

// Inicial
actualizarColores();
setInterval(actualizarDatos, 60000); // cada 60 segundos
</script>

</body>
</html>
