<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Planta</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Iconos (Opcional: Font Awesome) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f4f6f9;
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-height: 120px;
        }

        .card .card-body {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-icon {
            font-size: 2.5rem;
            opacity: 0.7;
        }

        .fs-value {
            font-size: 1.8rem;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="container my-4">
        <h1 class="text-center mb-4 fw-bold">Dashboard de Planta</h1>
        <!-- Cards de variables -->
        <div class="row g-4 justify-content-center text-white">
            <div class="col-12 col-md-3">
                <div id="cardTemp" class="card" style="background: linear-gradient(135deg,#2C3E50,#34495E);">
                    <div class="card-body">
                        <div>
                            <div class="card-title">Temperatura</div>
                            <div class="fs-value"><span id="temperatura">0</span>
                                °C</div>
                        </div>
                        <div class="card-icon"><i class="fas fa-thermometer-half"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div id="cardHumedadA" class="card" style="background: linear-gradient(135deg,#34495E,#5D6D7E);">
                    <div class="card-body">
                        <div>
                            <div class="card-title">Humedad Ambiente</div>
                            <div class="fs-value"><span id="humedad_aire">0</span>
                                %</div>
                        </div>
                        <div class="card-icon"><i class="fas fa-tint"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div id="cardHumedadS" class="card" style="background: linear-gradient(135deg,#1ABC9C,#16A085);">
                    <div class="card-body">
                        <div>
                            <div class="card-title">Humedad Suelo</div>
                            <div class="fs-value">
                                <span id="humedad_suelo">0</span> %
                            </div>
                        </div>
                        <div class="card-icon"><i class="fas fa-water"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div id="cardPeso" class="card text-dark" style="background: linear-gradient(135deg,#F1C40F,#F39C12);">
                    <div class="card-body">
                        <div>
                            <div class="card-title">Peso Planta</div>
                            <div class="fs-value"><span id="peso">0</span> kg</div>
                        </div>
                        <div class="card-icon"><i class="fas fa-weight-scale"></i></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="container my-3">
        <div class="row g-3">

            <!-- Planta -->
            <div class="col-md-3">
                <select id="plantaSelect" class="form-select">
                    <option value="">Todas las plantas</option>
                    {% for planta in plantas %}
                    <option value="{{ planta }}">{{ planta }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Desde -->
            <div class="col-md-3">
                <input type="datetime-local" id="desde" class="form-control">
            </div>

            <!-- Hasta -->
            <div class="col-md-3">
                <input type="datetime-local" id="hasta" class="form-control">
            </div>

            <!-- Límite -->
            <div class="col-md-2">
                <select id="limite" class="form-select">
                    <option value="20">20</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                </select>
            </div>

            <div class="col-md-1">
                <button class="btn btn-primary w-100" onclick="cargarDatos()">OK</button>
            </div>

        </div>
    </div>

    <!-- Gráfica -->
    <div class="container my-5">
        <div class="container my-3">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="chkTemp" checked>
                <label class="form-check-label" for="chkTemp">Temperatura</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="chkHumedadA" checked>
                <label class="form-check-label" for="chkHumedadA">Humedad Ambiente</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="chkHumedadS" checked>
                <label class="form-check-label" for="chkHumedadS">Humedad Suelo</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="chkPeso" checked>
                <label class="form-check-label" for="chkPeso">Peso</label>
            </div>
        </div>

        <canvas id="sensoresChart" height="200"></canvas>
        <div class="text-center text-muted my-2">
            Última actualización: <span id="timestamp">{{ latest.timestamp }}</span>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script>

        // Crear gráfica
        const ctx = document.getElementById('sensoresChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Temperatura (°C)', data: [], borderColor: '#FF4C4C', backgroundColor: 'rgba(255,76,76,0.2)', tension: 0.3, yAxisID: 'y' },
                    { label: 'Humedad Ambiente (%)', data: [], borderColor: '#4C6EFF', backgroundColor: 'rgba(76,110,255,0.2)', tension: 0.3, yAxisID: 'y1' },
                    { label: 'Humedad Suelo (%)', data: [], borderColor: '#28A745', backgroundColor: 'rgba(40,167,69,0.2)', tension: 0.3, yAxisID: 'y1' },
                    { label: 'Peso (kg)', data: [], borderColor: '#FFC107', backgroundColor: 'rgba(255,193,7,0.2)', tension: 0.3, yAxisID: 'y2' }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    zoom: {
                        zoom: {
                            wheel: { enabled: true },
                            pinch: { enabled: true },
                            mode: 'x'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { maxTicksLimit: 10, autoSkip: true }  // Menos saturación
                    },
                    y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Temperatura (°C)' } },
                    y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Humedad (%)' }, grid: { drawOnChartArea: false } },
                    y2: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Peso (kg)' }, grid: { drawOnChartArea: false } }
                }
            }
        });

        // Colores dinámicos según rango
        function actualizarColores() {
            let temp = parseFloat(document.getElementById('temperatura').innerText);
            let humS = parseFloat(document.getElementById('humedad_suelo').innerText);

            let cardTemp = document.getElementById('cardTemp');
            if (temp > 30) cardTemp.style.background = 'linear-gradient(135deg,#FF4C4C,#FF1F1F)';
            else if (temp >= 25) cardTemp.style.background = 'linear-gradient(135deg,#FF9F43,#FF6B00)';
            else cardTemp.style.background = 'linear-gradient(135deg,#4C6EFF,#2A4FFF)';

            let cardHumS = document.getElementById('cardHumedadS');
            if (humS < 40) cardHumS.style.background = 'linear-gradient(135deg,#FFC107,#E0A800)';
            else if (humS <= 60) cardHumS.style.background = 'linear-gradient(135deg,#28A745,#1E7E34)';
            else cardHumS.style.background = 'linear-gradient(135deg,#4C6EFF,#2A4FFF)';
        }

        // Actualización automática
        async function cargarDatos() {

            const planta = document.getElementById('plantaSelect').value;
            const desde = document.getElementById('desde').value;
            const hasta = document.getElementById('hasta').value;
            const limite = document.getElementById('limite').value;

            let url = `{% url 'sensor_api' %}?limite=${limite}`;

            if (planta) url += `&planta_id=${planta}`;
            if (desde) url += `&desde=${desde}`;
            if (hasta) url += `&hasta=${hasta}`;

            const response = await fetch(url);
            const data = await response.json();

            // Actualizar tarjetas
            document.getElementById('temperatura').innerText = data.latest.temperatura;
            document.getElementById('humedad_aire').innerText = data.latest.humedad_aire;
            document.getElementById('humedad_suelo').innerText = data.latest.humedad_suelo;
            document.getElementById('peso').innerText = data.latest.peso;
            document.getElementById('timestamp').innerText = data.latest.timestamp;

            // Actualizar gráfica
            chart.data.labels = data.timestamps;
            chart.data.datasets[0].data = data.temperatura;
            chart.data.datasets[1].data = data.humedad_aire;
            chart.data.datasets[2].data = data.humedad_suelo;
            chart.data.datasets[3].data = data.peso;

            chart.update();
            if (data.latest.temperatura > 35) {
                alert("⚠ Temperatura Crítica!");
            }
        }

        function actualizarVisibilidad() {
            chart.data.datasets[0].hidden = !document.getElementById('chkTemp').checked;
            chart.data.datasets[1].hidden = !document.getElementById('chkHumedadA').checked;
            chart.data.datasets[2].hidden = !document.getElementById('chkHumedadS').checked;
            chart.data.datasets[3].hidden = !document.getElementById('chkPeso').checked;
            chart.update();
        }

        // Detectar cambios en los checkboxes
        document.getElementById('chkTemp').addEventListener('change', actualizarVisibilidad);
        document.getElementById('chkHumedadA').addEventListener('change', actualizarVisibilidad);
        document.getElementById('chkHumedadS').addEventListener('change', actualizarVisibilidad);
        document.getElementById('chkPeso').addEventListener('change', actualizarVisibilidad);

        actualizarColores();
        setInterval(cargarDatos, 60000); // cada 1 minuto
    </script>

</body>

</html>