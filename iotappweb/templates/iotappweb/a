

<!-- CSS tanque visual -->
<style>
#nivelTanque {
    width: 60px;
    height: 180px;
    border: 2px solid #333;
    border-radius: 6px;
    background-color: #e0e0e0;
    position: relative;
    overflow: hidden;
    margin: auto;
}

#nivelFill {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: linear-gradient(135deg,#3498DB,#2980B9);
    transition: height 0.5s ease-in-out;
}
</style>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<script>
const ctxTanque = document.getElementById('tanqueChart').getContext('2d');
const tanqueChart = new Chart(ctxTanque, {
    type: 'line',
    data: {
        labels: [],
        datasets: [
            { label: 'Nivel (%)', data: [], borderColor: '#3498DB', backgroundColor: 'rgba(52,152,219,0.2)', tension: 0.3, yAxisID: 'y' },
            { label: 'Temperatura (°C)', data: [], borderColor: '#FF4C4C', backgroundColor: 'rgba(255,76,76,0.2)', tension: 0.3, yAxisID: 'y1' },
            { label: 'Caudal (L/min)', data: [], borderColor: '#1ABC9C', backgroundColor: 'rgba(26,188,156,0.2)', tension: 0.3, yAxisID: 'y2' }
        ]
    },
    options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
            zoom: {
                zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
            }
        },
        scales: {
            x: { ticks: { maxTicksLimit: 10, autoSkip: true } },
            y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Nivel (%)' } },
            y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Temperatura (°C)' }, grid: { drawOnChartArea: false } },
            y2: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Caudal (L/min)' }, grid: { drawOnChartArea: false } }
        }
    }
});

// Funciones
function actualizarNivelTanque(porcentaje) {
    document.getElementById('nivelFill').style.height = porcentaje + '%';
    document.getElementById('nivel').innerText = porcentaje;
}

// Checkboxes
document.getElementById('showNivel').addEventListener('change', () => { tanqueChart.data.datasets[0].hidden = !document.getElementById('showNivel').checked; tanqueChart.update(); });
document.getElementById('showTemp').addEventListener('change', () => { tanqueChart.data.datasets[1].hidden = !document.getElementById('showTemp').checked; tanqueChart.update(); });
document.getElementById('showCaudal').addEventListener('change', () => { tanqueChart.data.datasets[2].hidden = !document.getElementById('showCaudal').checked; tanqueChart.update(); });

// Cargar datos del tanque
async function cargarDatosTanque() {
    const tanque = document.getElementById('tanqueSelect').value;
    const desde = document.getElementById('desdeTanque').value;
    const hasta = document.getElementById('hastaTanque').value;
    const limite = document.getElementById('limiteTanque').value;

    let url = `/api/tanque/?limite=${limite}`;
    if (tanque) url += `&tanque_id=${tanque}`;
    if (desde) url += `&desde=${desde}`;
    if (hasta) url += `&hasta=${hasta}`;

    try {
        const response = await fetch(url);
        const data = await response.json();

        // Cards
        document.getElementById('tempAgua').innerText = data.latest.temperatura;
        document.getElementById('caudal').innerText = data.latest.caudal;
        actualizarNivelTanque(data.latest.nivel);
        document.getElementById('timestampTanque').innerText = data.latest.timestamp;

        // Gráfica
        tanqueChart.data.labels = data.timestamps;
        tanqueChart.data.datasets[0].data = data.nivel;
        tanqueChart.data.datasets[1].data = data.temperatura;
        tanqueChart.data.datasets[2].data = data.caudal;
        tanqueChart.update();
    } catch (err) {
        console.error("Error cargando datos del tanque:", err);
    }
}

// Auto actualizar cada minuto
setInterval(cargarDatosTanque, 60000);
cargarDatosTanque();
</script>
