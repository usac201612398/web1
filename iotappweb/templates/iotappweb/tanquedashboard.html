<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Tanque</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        #nivelTanque {
            width: 60px;
            height: 180px;
            border: 2px solid #333;
            border-radius: 6px;
            background-color: #e0e0e0;
            position: relative;
            overflow: hidden;
            margin: auto;
        }

        #nivelFill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(135deg, #3498DB, #2980B9);
            transition: height 0.5s ease-in-out;
        }

        .indicador-container {
            width: 60px;
            height: 180px;
            border: 2px solid #333;
            border-radius: 6px;
            background-color: #e9ecef;
            position: relative;
            margin: auto;
            overflow: hidden;
        }

        .indicador-bar {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 0%;
            transition: height 0.5s ease-in-out;
        }

        #nivelTanque {
            width: 60px;
            height: 180px;
            border: 2px solid #333;
            border-radius: 6px;
            background-color: #e0e0e0;
            position: relative;
            overflow: hidden;
            margin: auto;
        }
    </style>
    </style>
</head>

<body>

    <div class="container my-5">
        <h2 class="text-center mb-4 fw-bold">Dashboard del Tanque</h2>
        <!-- Indicadores principales -->
        <div class="row g-4 justify-content-center text-center my-4">

            <!-- Temperatura -->
            <div class="col-md-4">
                <div class="card p-3 shadow-sm">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-thermometer-half text-danger"></i> Temperatura
                    </h6>

                    <div class="indicador-container">
                        <div class="indicador-bar bg-danger" id="tempBar"></div>
                    </div>

                    <div class="fs-4 mt-3">
                        <span id="tempAgua">0</span> °C
                    </div>
                </div>
            </div>

            <!-- Caudal -->
            <div class="col-md-4">
                <div class="card p-3 shadow-sm">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-water text-primary"></i> Caudal
                    </h6>

                    <div class="indicador-container">
                        <div class="indicador-bar bg-primary" id="caudalBar"></div>
                    </div>

                    <div class="fs-4 mt-3">
                        <span id="caudal">0</span> L/min
                    </div>

                </div>
            </div>

            <!-- Nivel Tanque -->
            <div class="col-md-4">
                <div class="card p-3 shadow-sm">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-droplet text-info"></i> Nivel Tanque
                    </h6>

                    <div id="nivelTanque">
                        <div id="nivelFill"></div>
                    </div>

                    <div class="fs-5 mt-3">
                        <span id="porcentaje">0</span>%
                        (<span id="nivelCm">0</span> cm)
                    </div>

                </div>
            </div>

        </div>

        <!-- Panel de control -->
        <div class="row g-3 my-4">
            <!-- Riego -->
            <div class="col-md-6">
                <div class="card p-3">
                    <h5>Control Riego</h5>
                    <div class="btn-group my-2" role="group">
                        <button class="btn btn-success" data-bs-toggle="modal"
                            data-bs-target="#modalRiego">Regar</button>
                        <button class="btn btn-danger" onclick="enviarAccion('off','riego')">Detener</button>
                        <button class="btn btn-primary" onclick="enviarAccion('auto','riego')">Auto</button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted me-3">Regando</small>
                        <small class="text-muted me-3">En espera</small>
                        <small class="text-muted">Auto</small>
                    </div>
                    <div class="mt-1 fw-bold">Estado actual: <span id="estadoRiego">En espera</span></div>
                </div>
            </div>

            <!-- Tanque -->
            <div class="col-md-6">
                <div class="card p-3">
                    <h5>Control Tanque</h5>
                    <div class="btn-group my-2" role="group">
                        <button class="btn btn-success" onclick="enviarAccion('on','tanque')">Llenar</button>
                        <button class="btn btn-danger" onclick="enviarAccion('off','tanque')">Detener</button>
                        <button class="btn btn-primary" onclick="enviarAccion('auto','tanque')">Auto</button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted me-3">Llenando</small>
                        <small class="text-muted me-3">En espera</small>
                        <small class="text-muted">Auto</small>
                    </div>
                    <div class="mt-1 fw-bold">Estado actual: <span id="estadoTanque">En espera</span></div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <select id="tanqueSelect" class="form-select">
                    <option value="">Todos los tanques</option>
                    <option value="tanque01">Tanque 01</option>
                    <option value="tanque02">Tanque 02</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="datetime-local" id="desde" class="form-control">
            </div>
            <div class="col-md-3">
                <input type="datetime-local" id="hasta" class="form-control">
            </div>
            <div class="col-md-2">
                <select id="limite" class="form-select">
                    <option value="20">20</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                </select>
            </div>
            <div class="col-md-1">
                <button class="btn btn-primary w-100" onclick="cargarDatosTanque()">Consultar</button>
                <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalConsumo">
                    <i class="fas fa-chart-column me-2"></i>Consumo
                </button>
            </div>
        </div>
        <!-- Checkboxes -->
        <div class="my-3 text-center">
            <label class="me-2"><input type="checkbox" id="showNivel" checked> Nivel</label>
            <label class="me-2"><input type="checkbox" id="showTemp" checked> Temperatura</label>
            <label class="me-2"><input type="checkbox" id="showCaudal" checked> Caudal</label>
        </div>

        <!-- Gráfica -->
        <div class="container my-4">
            <canvas id="tanqueChart" height="200"></canvas>
        </div>
    </div>

    <!-- Modal Riego Manual -->
    <div class="modal fade" id="modalRiego" tabindex="-1" aria-labelledby="modalRiegoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalRiegoLabel">Riego Manual</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="formRiegoManual">
                        <div class="mb-3">
                            <label for="valvula" class="form-label">Válvula</label>
                            <select id="valvula" class="form-select">
                                <option value="1">Válvula 1</option>
                                <option value="2">Válvula 2</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="tiempo" class="form-label">Tiempo (segundos)</label>
                            <input type="number" class="form-control" id="tiempo" min="1" value="20">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="enviarRiegoManual()">Iniciar Riego</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-header">
        <h5 class="modal-title" id="modalConsumoLabel">
            Historial de Consumo (L) - {{ periodo|title }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
    </div>

    <!-- Modal Consumo Acumulado -->
    <div class="modal fade" id="modalConsumo" tabindex="-1" aria-labelledby="modalConsumoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalConsumoLabel">
                        Historial de Consumo (L) - {{ periodo|title }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3 text-end">
                        <label for="periodoSelect" class="form-label me-2">Período:</label>
                        <select id="periodoSelect" class="form-select d-inline-block w-auto"
                            onchange="cambiarPeriodo()">
                            <option value="semanal" {% ifequal periodo 'semanal' %}selected{% endifequal %}>Semanal
                            </option>
                            <option value="mensual" {% ifequal periodo 'mensual' %}selected{% endifequal %}>Mensual
                            </option>
                        </select>
                    </div>

                    <table class="table table-striped table-bordered table-sm text-center">
                        <thead class="table-light">
                            <tr>
                                <th>{% if periodo == 'semanal' %}Semana inicio{% else %}Fecha{% endif %}</th>
                                {% for planta in plantas %}
                                <th>{{ planta }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for fecha in fechas %}
                            <tr>
                                <td>
                                    {{ fecha|date:"d/m/Y" }}
                                </td>
                                {% for planta in plantas %}
                                <td>{{ tabla[fecha].get(planta)|default:0|floatformat:1 }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="modal-footer text-center">
                    <a href="{% url 'riegoshistorial' %}" class="btn btn-success btn-lg rounded-pill">
                        <i class="fas fa-home me-2"></i>Home
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="text-center mt-5">
        <a href="{% url 'riegoshistorial' %}" class="btn btn-success btn-lg rounded-pill">
            <i class="fas fa-home me-2"></i>Home
        </a>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script>
        const ctx = document.getElementById('tanqueChart').getContext('2d');

        const tanqueChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Temperatura (°C)', data: [], borderColor: '#FF4C4C', backgroundColor: 'rgba(255,76,76,0.2)', tension: 0.3, yAxisID: 'y' },
                    { label: 'Caudal (L/min)', data: [], borderColor: '#4C6EFF', backgroundColor: 'rgba(76,110,255,0.2)', tension: 0.3, yAxisID: 'y1' },
                    { label: 'Nivel (%)', data: [], borderColor: '#FFC107', backgroundColor: 'rgba(255,193,7,0.2)', tension: 0.3, yAxisID: 'y2' }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { ticks: { maxTicksLimit: 10 } },
                    y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Temperatura (°C)' } },
                    y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Caudal (L/min)' }, grid: { drawOnChartArea: false } },
                    y2: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Nivel (%)' }, grid: { drawOnChartArea: false } }
                }
            }
        });

        async function cargarDatosTanque() {
            const tanque = document.getElementById('tanqueSelect').value;
            const desde = document.getElementById('desde').value;
            const hasta = document.getElementById('hasta').value;
            const limite = document.getElementById('limite').value;

            let url = `{% url 'tanque_api' %}?limite=${limite}`;
            if (tanque) url += `&tanque_id=${tanque}`;
            if (desde) url += `&desde=${desde}`;
            if (hasta) url += `&hasta=${hasta}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                let porcentaje = parseFloat(data.latest.porcentaje_llenado) || 0;
                let nivelCm = parseFloat(data.latest.nivel) || 0;

                document.getElementById('tempAgua').innerText = data.latest.temperatura;
                document.getElementById('caudal').innerText = data.latest.caudal;
                porcentaje = Math.min(100, Math.max(0, porcentaje));
                document.getElementById('nivelFill').style.height = porcentaje + '%';
                document.getElementById('porcentaje').innerText = porcentaje.toFixed(0);
                document.getElementById('nivelCm').innerText = nivelCm.toFixed(1);
                document.getElementById('timestampTanque').innerText = data.latest.timestamp;

                tanqueChart.data.labels = data.timestamps;
                tanqueChart.data.datasets[0].data = data.temperatura;
                tanqueChart.data.datasets[1].data = data.caudal;
                tanqueChart.data.datasets[2].data = data.porcentaje_llenado;

                tanqueChart.data.datasets[0].hidden = !document.getElementById('showTemp').checked;
                tanqueChart.data.datasets[1].hidden = !document.getElementById('showCaudal').checked;
                tanqueChart.data.datasets[2].hidden = !document.getElementById('showNivel').checked;

                tanqueChart.update();
            } catch (err) {
                console.error("Error cargando datos del tanque:", err);
            }
        }

        document.getElementById('showTemp').addEventListener('change', cargarDatosTanque);
        document.getElementById('showCaudal').addEventListener('change', cargarDatosTanque);
        document.getElementById('showNivel').addEventListener('change', cargarDatosTanque);

        cargarDatosTanque();
        setInterval(cargarDatosTanque, 10000);

        let estadoRiegoActual = 'En espera';
        let estadoTanqueActual = 'En espera';

        function setRiego(accion) {
            switch (accion) {
                case 'on': estadoRiegoActual = 'Regando'; break;
                case 'off': estadoRiegoActual = 'En espera'; break;
                case 'auto': estadoRiegoActual = 'Auto'; break;
            }
            document.getElementById('estadoRiego').innerText = estadoRiegoActual;
        }

        function setTanque(accion) {
            switch (accion) {
                case 'on': estadoTanqueActual = 'Llenando'; break;
                case 'off': estadoTanqueActual = 'En espera'; break;
                case 'auto': estadoTanqueActual = 'Auto'; break;
            }
            document.getElementById('estadoTanque').innerText = estadoTanqueActual;
        }

        function enviarAccion(accion, dispositivo) {
            accion = accion.toLowerCase();
            dispositivo = dispositivo.toLowerCase();

            fetch("{% url 'enviarinstruccion' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: `accion=${accion}&dispositivo=${dispositivo}`
            })
                .then(res => res.json())
                .then(data => {
                    let estadoTexto = '';
                    switch (accion) {
                        case 'on': estadoTexto = (dispositivo === 'riego') ? 'regando' : 'llenando'; break;
                        case 'off': estadoTexto = 'en espera'; break;
                        case 'auto': estadoTexto = 'auto'; break;
                    }

                    if (dispositivo === 'riego') document.getElementById('estadoRiego').innerText = estadoTexto;
                    else if (dispositivo === 'tanque') document.getElementById('estadoTanque').innerText = estadoTexto;
                })
                .catch(err => console.error("Error:", err));
        }

        function enviarRiegoManual() {
            const valvula = document.getElementById('valvula').value;
            const tiempo = document.getElementById('tiempo').value;

            if (!tiempo || tiempo <= 0) {
                alert("Ingrese un tiempo válido");
                return;
            }

            const payload = { accion: 'on', valvula: valvula, tiempo: tiempo, dispositivo: 'riego' };

            fetch("{% url 'enviarinstruccion' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(data => {
                    console.log("Riego Manual:", data);
                    document.getElementById('estadoRiego').innerText = `Regando ${tiempo} seg`;
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalRiego'));
                    modal.hide();
                })
                .catch(err => console.error("Error:", err));
        }

    </script>
    <script>
        function cambiarPeriodo() {
            const periodo = document.getElementById('periodoSelect').value;
            // Recargamos el modal vía GET
            fetch(`{% url 'consumo_acumulado' %}?periodo=${periodo}`)
                .then(res => res.text())
                .then(html => {
                    document.getElementById('modalConsumo').innerHTML = html;
                    const modal = new bootstrap.Modal(document.getElementById('modalConsumo'));
                    modal.show();
                });
        }
    </script>
</body>

</html>