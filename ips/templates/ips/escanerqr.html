<!DOCTYPE html>
<html lang="en">
    %load static%
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escanear Código QR</title>
    <!-- Incluir la librería html5-qrcode -->
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
    <h1>Escanear Código QR</h1>

    <!-- Contenedor donde se muestra la cámara -->
    <div id="qr-reader" style="width: 500px; height: 500px;"></div>

    <!-- Mostrar el resultado del escaneo -->
    <p>QR Escaneado: <span id="qr-result"></span></p>
    
    <!-- Input para ingresar la cantidad -->
    <div id="cantidad-container" style="display:none;">
        <label for="cantidad">Cantidad a agregar:</label>
        <input type="number" id="cantidad" name="cantidad" min="1">
        <button id="confirmar-cantidad">Confirmar</button>
    </div>

    <script type="text/javascript" src="{% static '/lib/cockies.js' %}"></script>
    <script>
        // Esperar que la librería esté completamente cargada antes de usarla
        document.addEventListener('DOMContentLoaded', function () {
            // Comprobamos si Html5Qrcode está disponible
            if (typeof Html5Qrcode === 'undefined') {
                console.error('Html5Qrcode no está definido.');
                return;
            }

            // Función de inicio del escáner
            function onScanSuccess(decodedText, decodedResult) {
                // Muestra el resultado del escaneo
                document.getElementById('qr-result').innerText = decodedText;

                // Muestra el campo para ingresar la cantidad
                document.getElementById('cantidad-container').style.display = "block";
                
                // Al hacer clic en "Confirmar", enviamos la información
                document.getElementById('confirmar-cantidad').addEventListener('click', function() {
                    const cantidad = document.getElementById('cantidad').value;
                    if (cantidad && cantidad > 0) {
                        // Crea el objeto JSON con los datos
                        const data = {
                            qr_data: decodedText,
                            cantidad: cantidad
                        };

                        // Enviar los datos al backend de Django (AJAX)
                        fetch("{% url 'save_qr' %}", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json", // Especificamos que estamos enviando JSON
                                'X-CSRFToken': getCookie('csrftoken') // Token CSRF para Django
                            },
                            body: JSON.stringify(data) // Convertimos el objeto a una cadena JSON
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);
                            alert(data.message || 'Error al guardar el QR');
                        })
                        .catch(error => console.error('Error:', error));
                    } else {
                        alert("Por favor ingrese una cantidad válida.");
                    }
                });
            }

            // Configura el escáner QR
            const html5QrCode = new Html5Qrcode("qr-reader");

            // Iniciar el escáner QR con la cámara trasera
            html5QrCode.start(
                { facingMode: "environment" }, // Usar la cámara trasera
                { fps: 10, qrbox: 250 }, // Configuración de FPS y tamaño del cuadro de escaneo
                onScanSuccess
            ).catch(err => {
                console.error("Error al iniciar el escáner:", err);
            });
        });
    </script>
</body>
</html>
